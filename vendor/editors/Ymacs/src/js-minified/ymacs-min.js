//> This file is part of Ymacs, an Emacs-like editor for the Web
//> http://www.ymacs.org/
//>
//> Copyright (c) 2009, Mihai Bazon, Dynarch.com.  All rights reserved.
//>
//> Redistribution and use in source and binary forms, with or without
//> modification, are permitted provided that the following conditions are
//> met:
//>
//>     * Redistributions of source code must retain the above copyright
//>       notice, this list of conditions and the following disclaimer.
//>
//>     * Redistributions in binary form must reproduce the above copyright
//>       notice, this list of conditions and the following disclaimer in
//>       the documentation and/or other materials provided with the
//>       distribution.
//>
//>     * Neither the name of Dynarch.com nor the names of its contributors
//>       may be used to endorse or promote products derived from this
//>       software without specific prior written permission.
//>
//> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER “AS IS” AND ANY
//> EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
//> IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
//> PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE
//> FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
//> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
//> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
//> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
//> THE POSSIBILITY OF SUCH DAMAGE.
DEFINE_CLASS("Ymacs",DlLayout,function(b,a){b.DEFAULT_EVENTS=["onBufferSwitch"];b.DEFAULT_ARGS={buffers:["buffers",null],frames:["frames",null],_focusable:["focusable",true]};b.FIXARGS=function(c){if(!c.buffers){c.buffers=[]}if(!c.frames){c.frames=[]}};b.CONSTRUCT=function(){this.buffers.foreach(function(e){e.ymacs=this},this);this.killRing=[];this.killMasterOfRings=[];this.progress={};this.updateModelineWithTimer=this.updateModeline.clearingTimeout(0,this);this.minibuffer=this.createBuffer({hidden:true,isMinibuffer:true});this.minibuffer.cmd("minibuffer_mode");this.minibuffer_frame=this.createFrame({isMinibuffer:true,buffer:this.minibuffer,hidden:true,highlightCurrentLine:false,className:"Ymacs_Minibuffer"});this.modeline=new DlContainer({className:"Ymacs_Modeline"});this.modeline.setContent("--Ymacs--");if(this.buffers.length==0){this.createBuffer()}var c=this.topCont=new DlContainer({});var d=this.createFrame({parent:c,buffer:this.buffers[0]});this.packWidget(this.minibuffer_frame,{pos:"bottom"});this.packWidget(this.modeline,{pos:"bottom"});this.packWidget(c,{pos:"top",fill:"*"});this.__activeFrameEvents={onPointChange:this._on_activeFramePointChange.$(this)};this.setActiveFrame(d);d._redrawCaret()};a.pushToKillRing=function(d,c){c?this.killRing.unshift(d):this.killRing.push(d)};a.killRingToMaster=function(){if(this.killRing.length&&(this.killMasterOfRings.length==0||this.killMasterOfRings.peek().join("")!=this.killRing.join(""))){this.killMasterOfRings.push(this.killRing)}this.killRing=[]};a.killRingText=function(){return this.killRing.join("")};a.rotateKillRing=function(c){if(c){this.killMasterOfRings.push(this.killRing);this.killRing=this.killMasterOfRings.shift()}else{this.killMasterOfRings.unshift(this.killRing);this.killRing=this.killMasterOfRings.pop()}};a.getBuffer=function(c){if(!(c instanceof Ymacs_Buffer)){c=this.buffers.grep_first(function(d){return d.name==c})}return c};a.killBuffer=function(c){c=this.getBuffer(c);if(this.buffers.length>1){if(this.getActiveBuffer()===c){this.switchToNextBuffer()}}else{this.switchToBuffer(this.createBuffer())}this.buffers.remove(c);c.destroy()};a.renameBuffer=function(d,c){d=this.getBuffer(d);d.name=c;this.updateModelineWithTimer()};a._do_switchToBuffer=function(c){this.getActiveFrame().setBuffer(c);this.callHooks("onBufferSwitch",c)};a.switchToBuffer=function(e){var d=this.getBuffer(e),c=this.buffers;if(!d){d=this.createBuffer({name:e})}c.remove(d);c.unshift(d);this._do_switchToBuffer(d);return d};a.switchToNextBuffer=function(e){var c=this.buffers;if(c.length>1){var d=c.shift();c.push(d);this._do_switchToBuffer(c[0])}};a.switchToPreviousBuffer=function(e){var c=this.buffers;if(c.length>1){var d=c.pop();c.unshift(d);this._do_switchToBuffer(d)}};a.getNextBuffer=function(d,e){if(e==null){e=1}var c=this.buffers;return c[c.rotateIndex(c.find(d)+e)]};a.getPrevBuffer=function(d,e){if(e==null){e=1}var c=this.buffers;return c[c.rotateIndex(c.find(d)-e)]};a.createBuffer=function(d){if(!d){d={}}Object.merge(d,{ymacs:this});var c=new Ymacs_Buffer(d);if(!d.hidden){this.buffers.push(c)}return c};a.createFrame=function(c){if(!c){c={}}Object.merge(c,{ymacs:this});var d=new Ymacs_Frame(c);if(!c.hidden){this.frames.unshift(d)}d.addEventListener("onDestroy",function(e){this.frames.remove(e)}.$(this,d));return d};a.keepOnlyFrame=function(c){if(this.frames.length>1){c.parent.removeWidget(c);this.frames.remove(c);this.topCont.destroyChildWidgets();this.topCont.appendWidget(c);this.topCont.__doLayout();this.setActiveFrame(c)}};a.focusOtherFrame=function(){this.setActiveFrame(this.frames[0])};a.focus=function(){b.BASE.focus.apply(this,arguments);this.frames.peek().focus()};a.setActiveFrame=function(e,d){var c=this.getActiveFrame();if(c){c.removeEventListener(this.__activeFrameEvents)}if(!e.isMinibuffer){this.frames.remove(e);this.frames.push(e)}else{this.frames.unshift(this.frames.pop())}this.updateModelineWithTimer();e.addEventListener(this.__activeFrameEvents);if(!d){e.focus()}};a.getActiveFrame=function(){return this.frames.peek()};a.getActiveBuffer=function(){var c=this.getActiveFrame();return c?c.buffer:this.buffers.peek()};a.updateProgress=function(c,d){if(d==null){delete this.progress[c]}else{this.progress[c]=d}this.updateModelineWithTimer()};a.updateModeline=function(){var c=this.getActiveBuffer();if(this.modeline&&c!==this.minibuffer){var e=c._rowcol;var g=String.buffer("-- <b>",c.name.htmlEscape(),"</b> (",e.row+1,",",e.col,") ");var f=[];for(var d in this.progress){f.push(d+": "+this.progress[d])}if(f.length>0){g("[",f.join(", "),"]")}this.modeline.setContent(g.get())}};a.setColorTheme=function(c){this.delClass(/Ymacs-Theme-[^\s]*/g);this.addClass("Ymacs-Theme-"+c)};a._on_activeFramePointChange=function(){this.updateModelineWithTimer()}});window.Ymacs_Regexp=(function(){var b={};function a(d){if(d instanceof RegExp){d=d.toString()}var e=d.lastIndexOf("/"),c="";c=d.substr(e+1);d=d.substring(1,e);return{pattern:d,flags:c}}return{search_backward:function(e){var c=e.toString();var d=b[c];if(!d){e=a(c);e.flags=e.flags.replace(/g/g,"")+"g";d=new RegExp("([^]*)("+e.pattern+")",e.flags);b[c]=d}d.lastIndex=0;return d}}})();DEFINE_CLASS("Ymacs_Frame",DlContainer,function(a,h,m){var i=300;var d=DlException.stopEventBubbling;a.DEFAULT_EVENTS=["onPointChange"];a.DEFAULT_ARGS={highlightCurrentLine:["highlightCurrentLine",true],buffer:["buffer",null],ymacs:["ymacs",null],isMinibuffer:["isMinibuffer",false],_scrollBars:["scroll",true],_focusable:["focusable",true],_fillParent:["fillParent",true]};var b=200;a.CONSTRUCT=function(){this.__blinkCaret=this.__blinkCaret.$(this);this.__caretId=Dynarch.ID();this._bufferEvents={onLineChange:this._on_bufferLineChange.$(this),onInsertLine:this._on_bufferInsertLine.$(this),onDeleteLine:this._on_bufferDeleteLine.$(this),onPointChange:this._on_bufferPointChange.$(this),onResetCode:this._on_bufferResetCode.$(this),onOverwriteMode:this._on_bufferOverwriteMode.$(this),beforeInteractiveCommand:this._on_bufferBeforeInteractiveCommand.$(this)};this._moreBufferEvents={onMessage:this._on_bufferMessage.$(this),onOverlayChange:this._on_bufferOverlayChange.$(this),onOverlayDelete:this._on_bufferOverlayDelete.$(this)};var n=this.buffer;this.buffer=null;if(n){this.setBuffer(n)}};h.initDOM=function(){a.BASE.initDOM.apply(this,arguments);this.getElement().innerHTML="<div class='Ymacs-frame-content'></div>";this.addEventListener({onDestroy:this._on_destroy,onFocus:this._on_focus,onBlur:this._on_blur,onMouseDown:this._on_mouseDown,onKeyPress:this._on_keyPress,onResize:this.centerOnCaret});this._dragSelectCaptures={onMouseOver:d,onMouseOut:d,onMouseEnter:d,onMouseLeave:d,onMouseMove:e.$(this),onMouseUp:j.$(this)}};h.focus=function(n){a.BASE.focus.call(this);if(n instanceof Function){this.removeEventListener("onBlur",this.__exitFocusHandler);this.addEventListener("onBlur",this.__exitFocusHandler=function(){if(n.call(this.buffer)){this.removeEventListener("onBlur",this.__exitFocusHandler)}else{this.focus.delayed(2,this,null)}})}};h.blur=function(n){if(n){this.removeEventListener("onBlur",this.__exitFocusHandler)}a.BASE.blur.call(this)};h.getContentElement=function(){return this.getElement().firstChild};h.getCaretElement=function(){return document.getElementById(this.__caretId)};h.getLineDivElement=function(n){return this.getContentElement().childNodes[n]};h.ensureCaretVisible=function(){this._redrawCaret();var p=this.getCaretElement();if(!p){return}var q=this.getElement(),n=this.getLineDivElement(this.buffer._rowcol.row);var o=n.offsetTop+n.offsetHeight-(q.scrollTop+q.clientHeight);if(o>0){q.scrollTop+=o}else{o=n.offsetTop-q.scrollTop;if(o<0){q.scrollTop+=o}}o=p.offsetLeft+p.offsetWidth-(q.scrollLeft+q.clientWidth);if(o>0){q.scrollLeft+=o}else{o=p.offsetLeft-q.scrollLeft;if(o<0){q.scrollLeft+=o}}};h.setBuffer=function(n){if(this.buffer){if(this.caretMarker&&!this.isMinibuffer){this.caretMarker.destroy();this.caretMarker=null}this.buffer.removeEventListener(this._bufferEvents);this.buffer.removeEventListener(this._moreBufferEvents)}this.buffer=n;if(n){this.buffer.addEventListener(this._bufferEvents);if(this.focusInside()){n.addEventListener(this._moreBufferEvents)}if(this.isMinibuffer){this.caretMarker=n.caretMarker}else{this.caretMarker=n.createMarker(n.caretMarker.getPosition())}this._redrawBuffer();this._redrawCaret(true);this.centerOnCaret()}};h.centerOnCaret=function(){this.centerOnLine(this.buffer._rowcol.row)};h.centerOnLine=function(o){var n=this.getLineDivElement(o),p=this.getElement();p.scrollTop=Math.round(n.offsetTop-p.clientHeight/2+n.offsetHeight/2)};h.deleteOtherFrames=function(){this.ymacs.keepOnlyFrame(this)};h.vsplit=function(){var n=this.parent;var q=new DlContainer({});var p=new DlContainer({});q.appendWidget(this);var o=this.ymacs.createFrame({parent:p,buffer:this.buffer});var r=new DlLayout({parent:n});r.packWidget(q,{pos:"top",fill:"50%"});var s=new DlResizeBar({widget:q,horiz:true});r.packWidget(s,{pos:"top"});r.packWidget(p,{pos:"top",fill:"*"});n.__doLayout()};h.hsplit=function(){var n=this.parent;var q=new DlContainer({});var p=new DlContainer({});q.appendWidget(this);var o=this.ymacs.createFrame({parent:p,buffer:this.buffer});var r=new DlLayout({parent:n});r.packWidget(q,{pos:"left",fill:"50%"});var s=new DlResizeBar({widget:q});r.packWidget(s,{pos:"left"});r.packWidget(p,{pos:"left",fill:"*"});n.__doLayout()};h.toggleLineNumbers=function(){this.condClass(this.__lineNumbers=!this.__lineNumbers,"Ymacs-line-numbers")};function l(t,q,s){if(/^br$/i.test(t.firstChild.tagName)){t.insertBefore(s,t.firstChild);return s}var o=0,n={};function p(y){for(var v=y.firstChild;v;v=v.nextSibling){if(v.nodeType==3){var u=v.length;if(o+u>q){var x=q-o;var w=v.splitText(x);y.insertBefore(s,w);throw n}else{if(o+u==q){y.insertBefore(s,v.nextSibling);throw n}}o+=u}else{if(v.nodeType==1){p(v)}}}}try{p(t)}catch(r){if(r===n){return s}throw r}}h.setMarkerAtPos=function(o,n){if(!o.tagName){o=this.getLineDivElement(o)}if(o){return l(o,n,m.createElement("span"))}};h.__restartBlinking=function(){this.__stopBlinking();if(this.focusInside()){this.__caretTimer=setInterval(this.__blinkCaret,b)}};h.__stopBlinking=function(){clearInterval(this.__caretTimer);this.__showCaret()};h.__blinkCaret=function(){m.condClass(this.getCaretElement(),this.BLINKING=!this.BLINKING,"Ymacs-caret")};h.__showCaret=function(){m.addClass(this.getCaretElement(),"Ymacs-caret")};h._unhoverLine=function(){if(this.__hoverLine!=null){m.delClass(this.getLineDivElement(this.__hoverLine),"Ymacs-current-line");this.__hoverLine=null}};h._redrawCaret=function(p){var n=this.ymacs.getActiveFrame()===this;if(!p&&!n){return}if(n&&!this.isMinibuffer){this.caretMarker.setPosition(this.buffer.caretMarker.getPosition())}var o=this.buffer._rowcol;if(this.highlightCurrentLine){this._unhoverLine();m.addClass(this.getLineDivElement(o.row),"Ymacs-current-line");this.__hoverLine=o.row}if(this.__prevCaretLine!=null){this._on_bufferLineChange(this.__prevCaretLine)}if(this.__prevCaretLine!=o.row){this.__prevCaretLine=o.row;this._on_bufferLineChange(o.row)}if(n){this.__restartBlinking()}this.callHooks("onPointChange",o.row,o.col)};h._getLineHTML=function(o){var n=this.buffer.formatLineHTML(o,this.caretMarker);var p=n.indexOf("Ymacs-caret'>");if(p>=0){n=n.substr(0,p+12)+" id='"+this.__caretId+"'"+n.substr(p+12)}return n};h._redrawBuffer=function(){this.setContent(this.buffer.code.map(function(n,o){return this._getLineHTML(o).htmlEmbed("div","line")},this).join(""))};h.coordinatesToRowCol=function(o,t){function n(v,u){if(v==u){return v}var y=Math.floor((v+u)/2),z=p.getLineDivElement(y),x=z.offsetTop,w=x+z.offsetHeight-1;if(w<t){return n(y+1,u)}if(t<x){return n(v,y-1)}return y}function r(w,v){if(w==v){return w}var u=Math.floor((w+v)/2);var y=p.coordinates(s,u),x=p.coordinates(s,u+1);if(x.x<o){return r(u+1,v)}if(o<y.x){return r(w,u-1)}return u}var p=this,s=n(0,this.buffer.code.length-1),q=r(0,this.buffer.code[s].length);return{row:s,col:q}};h.coordinates=function(q,o){var r=this.getLineDivElement(q);var p=this.setMarkerAtPos(r,o);var n={x:p.offsetLeft,y:r.offsetTop,h:r.offsetHeight};m.trash(p);return n};h.heightInLines=function(){return Math.floor(this.getElement().clientHeight/this.getCaretElement().offsetHeight)};h._on_bufferLineChange=function(n){var o=this.getLineDivElement(n);if(o){o.innerHTML=this._getLineHTML(n)}};h._on_bufferInsertLine=function(o,n){var p;if(n){p=m.createFromHtml(this._getLineHTML(o).htmlEmbed("div","line"))}else{p=m.createElement("div",null,{className:"line"})}this.getContentElement().insertBefore(p,this.getLineDivElement(o))};h._on_bufferDeleteLine=function(n){m.trash(this.getLineDivElement(n))};h._on_bufferPointChange=function(n,o){this._redrawCaret()};h._on_bufferResetCode=function(){this._redrawBuffer()};h._on_bufferOverwriteMode=function(n){this.condClass(n,"Ymacs-overwrite-mode")};h._on_bufferMessage=function(q,r,p){var o=this.isMinibuffer?this.ymacs:this;var n=Ymacs_Message_Popup.get(0);n.popup({content:p?r:r.htmlEscape(),widget:o,anchor:o.getElement(),align:{prefer:"CC",fallX1:"CC",fallX2:"CC",fallY1:"CC",fallY2:"CC"}});n.hide(5000)};h._on_bufferBeforeInteractiveCommand=function(){this._unhoverLine();Ymacs_Message_Popup.clearAll()};h.getOverlayId=function(n){return this.id+"-ovl-"+n};h.getOverlayHTML=function(n,o){if(o.line1==o.line2&&o.col1==o.col2){return null}var r=this.coordinates(o.line1,o.col1);var p=this.coordinates(o.line2,o.col2);var q=String.buffer("<div id='",this.getOverlayId(n),"' class='Ymacs_Overlay ",n,"' style='top:",r.y,"px'>");if(o.line1==o.line2){q("<div class='",n,"' style='margin-left:",r.x,"px; width:",p.x-r.x,"px;height:",p.h,"px;'>&nbsp;</div>")}else{q("<div class='",n,"' style='margin-left:",r.x,"px;height:",r.h,"px;'>&nbsp;</div>");if(o.line2-o.line1>1){q("<div class='",n,"' style='height:",p.y-r.y-r.h,"px'></div>")}q("<div class='",n,"' style='width:",p.x,"px;height:",p.h,"px;'>&nbsp;</div>")}q("</div>");return q.get()};h.getOverlaysCount=function(){return this.getElement().childNodes.length-1};h._on_bufferOverlayChange=function(o,p,n){if(!n){m.trash($(this.getOverlayId(o)))}var q=this.getOverlayHTML(o,p);if(q){q=m.createFromHtml(q);this.getElement().appendChild(q);this.condClass(this.getOverlaysCount()>0,"Ymacs_Frame-hasOverlays")}};h._on_bufferOverlayDelete=function(o,p,n){m.trash($(this.getOverlayId(o)));this.condClass(this.getOverlaysCount()>0,"Ymacs_Frame-hasOverlays")};h._on_destroy=function(){this.setBuffer(null);this.__stopBlinking()};h._on_focus=function(){window.focus();this.ymacs.setActiveFrame(this,true);if(!this.isMinibuffer){this.buffer.cmd("goto_char",this.caretMarker.getPosition())}this.buffer.addEventListener(this._moreBufferEvents);this.__restartBlinking()};h._on_blur=function(){if(!this.isMinibuffer){this.caretMarker.setPosition(this.buffer.caretMarker.getPosition())}this.buffer.removeEventListener(this._moreBufferEvents);this.__stopBlinking()};var f=0,c=null,g=null;function k(){f=null}h._on_mouseDown=function(o){clearTimeout(c);f++;c=k.delayed(i);this.__restartBlinking();var q=o.computePos(this.getContentElement()),p=this.coordinatesToRowCol(q.x,q.y),n=this.buffer;n.clearTransientMark();n.cmd("goto_char",n._rowColToPosition(p.row,p.col));if(f==1){n.ensureTransientMark();DlEvent.captureGlobals(this._dragSelectCaptures)}else{if(f==2){n.cmd("backward_word");n.cmd("forward_word_mark")}else{if(f==3){n.cmd("beginning_of_line");n.cmd("end_of_line_mark")}else{if(f==4){n.cmd("backward_paragraph");n.cmd("forward_whitespace");n.cmd("beginning_of_line");n.cmd("forward_paragraph_mark")}}}}d()};function e(n){var p=n.computePos(this.getContentElement()),o=this.coordinatesToRowCol(p.x,p.y);this.buffer.cmd("goto_char",this.buffer._rowColToPosition(o.row,o.col));this.buffer.ensureTransientMark();this.ensureCaretVisible()}function j(n){DlEvent.releaseGlobals(this._dragSelectCaptures)}h._on_keyPress=function(n){if(this.buffer._handleKeyEvent(n)){d()}}});DEFINE_CLASS("Ymacs_Message_Popup",DlPopup,function(b,a){b.FIXARGS=function(c){c.focusable=false;c.autolink=false;c.zIndex=5000}});DEFINE_CLASS("Ymacs_Text_Properties",DlEventProxy,function(b,a){b.DEFAULT_EVENTS=["onChange"];b.DEFAULT_ARGS={buffer:["buffer",null]};b.CONSTRUCT=a.reset=function(){this.props=[]};a.insertLine=function(c){if(this.props.length<c){this.props[c]=null}else{this.props.splice(c,0,null)}};a.deleteLine=function(c){this.props.splice(c,1)};a.replaceLine=function(e,d){var c=this.props[e];if(c&&c.length>d.length){c.splice(d.length,c.length)}};a.addLineProps=function(k,d,c,l,h){var e=this.props,g,f=false;if(d<c){e=e[k]||(e[k]=[]);while(d<c){g=e[d]||(e[d]={});if(g[l]!=h){f=true}g[l]=h;++d}if(f){this.callHooks("onChange",k)}}return f};a.removeLineProps=function(h,d,c,k){var e=this.props[h],g,f=false;if(e&&d<c){while(d<c){g=e[d];if(g&&k in g){f=true;delete g[k]}++d}if(f){this.callHooks("onChange",h)}}return f};a.getLineHTML=function(m,l,j){var d=this.props[m];if(j===null){if(l==""){return"<br/>"}if(!d||d.length==0){return l.htmlEscape()}}else{if(l==""){return"<span class='Ymacs-caret'>&nbsp;</span>"}if(!d||d.length==0){if(j===l.length){return l.htmlEscape()+"<span class='Ymacs-caret'>&nbsp;</span>"}return l.substr(0,j).htmlEscape()+"<span class='Ymacs-caret'>"+l.charAt(j).htmlEscape()+"</span>"+l.substr(j+1).htmlEscape()}}var g=0,f=l.length,k=null,e,h="",c;while(g<f){e=d[g];e=e&&e.css;if(g===j){e=e?e+" Ymacs-caret":"Ymacs-caret"}if(e&&e!=k){if(k){h+="</span>"}h+="<span class='"+e+"'>"}else{if(!e&&k){h+="</span>"}}k=e;c=l.charAt(g);switch(c){case"<":h+="&lt;";break;case">":h+="&gt;";break;case"&":h+="&amp;";break;default:h+=c;break}++g}if(k){h+="</span>"}if(g===j){h+="<span class='Ymacs-caret'>&nbsp;</span>"}return h}});function Ymacs_Exception(a){this.message=a}(function(){window.Ymacs_Interactive=function(z,A){if(arguments.length==1){A=z;z=null}else{var y;if(!(A instanceof Function)){y=A;A=arguments[2];A.ymacsDoc=y}}A.ymacsInteractive=true;if(z instanceof Function){A.ymacsGetArgs=z}else{if(z!=null){if(!(z instanceof Array)){var x=/^[\^\@\*]+/.exec(z);if(x){x=x[0];z=z.substr(x.length);if(x.indexOf("^")>=0){A.ymacsMarkExtend=true}if(x.indexOf("*")>=0){A.ymacsWarnReadonly=true}if(x.indexOf("@")>=0){A.ymacsSelectFrame=true}}if(z){z=z.split(/\n+/)}}if(z){var C,B=function(){C.append(Array.$(arguments));return this.callInteractively(A,C,true)};while(z.length>0){B=h(z.pop(),function(D){C.append(Array.$(arguments,1));D.call(this)}.$(null,B))}A.ymacsCallInteractively=function(){C=[];return B.call(this)}}else{A.ymacsCallInteractively=A}}else{A.ymacsCallInteractively=A}}return A};window.Ymacs_Interactive_X=function(x){return Ymacs_Interactive("p",function(y){if(y==null){y=1}y.times(x,this)})};var n=(function(){});n.toString=function(){return""};n.empty=true;function c(x){var y=this.getPrefixArg(true);if(y){x=y+" "+x}return x}function q(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_function",x)}function i(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_buffer",x)}function k(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_buffer",x)}function w(y,x){}function v(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_command",x)}function g(y,x){x.call(this,this.point())}function l(y,x){}function j(y,x){x.call(this,null)}function u(y,x){}function s(y,x){}function e(y,x){x.call(this,this.markMarker.getPosition())}function b(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_string",null,x)}function d(y,x){this.cmd("minibuffer_prompt",c.call(this,y));this.cmd("minibuffer_read_number",x)}function f(y,x){var z=parseInt(this.getPrefixArg(),10);if(!isNaN(z)){x.call(this,z)}else{d.call(this,y,x)}}function o(y,x){var z=parseInt(this.getPrefixArg(),10);if(isNaN(z)){z=null}x.call(this,z)}function p(y,x){y=this.getPrefixArg();if(y===""){y=n}x.call(this,y)}function a(y,x){var z=this.getRegion();x.call(this,z.begin,z.end)}function r(y,x){}function t(y,x){}var m={a:q,b:i,B:k,c:w,C:v,d:g,e:l,i:j,k:u,K:s,m:e,M:b,n:d,N:f,p:o,P:p,r:a,s:b,U:r,v:t};function h(y,x){var z=y.charAt(0);y=y.substr(1);return m[z].$(null,y,x)}})();DEFINE_CLASS("Ymacs_Buffer",DlEventProxy,function(a,d){a.DEFAULT_EVENTS=["onLineChange","onInsertLine","onDeleteLine","onPointChange","onResetCode","onMessage","onOverwriteMode","onOverlayChange","onOverlayDelete","beforeInteractiveCommand","afterInteractiveCommand","finishedEvent"];a.DEFAULT_ARGS={name:["name","*scratch*"],_code:["code",null],ymacs:["ymacs",null],tokenizer:["tokenizer",null],isMinibuffer:["isMinibuffer",false]};var g={case_fold_search:true,line_movement_requested_col:0,fill_column:78,tab_width:8,indent_level:8,syntax_word:{test:h},syntax_word_dabbrev:{test:b},syntax_paragraph_sep:/\n\s*\n/g};function f(l,n){if(typeof l=="string"){if(n===undefined){delete this[l]}else{this[l]=n}return n}else{var m={};for(var k in l){m[k]=this[k];f.call(this,k,l[k])}return m}}var e=50000;function j(k){return k instanceof Ymacs_Marker?k.getPosition():k}function h(l){if(l){var k=l.charCodeAt(0);return(k>=48&&k<=57)||l.toUpperCase()!=l.toLowerCase()}}function b(l){if(l){var k=l.charCodeAt(0);return(k>=48&&k<=57)||l=="_"||l.toUpperCase()!=l.toLowerCase()}}d.lastIndexOfRegexp=function(q,o,p,n){q=q.substring(0,p);o=Ymacs_Regexp.search_backward(o);o.lastIndex=n||0;var k=o.exec(q);if(k){var l=Array.$(k,2);l.index=k.index+k[1].length;l.after=k.index+k[0].length;l[0]=q.substring(l.index,l.after);this.matchData=l;return l}};a.COMMANDS=d.COMMANDS={};a.newCommands=d.newCommands=function(k){for(var l in k){var m=k[l];m.ymacsCommand=l;this.COMMANDS[l]=m}};a.newMode=d.newMode=function(k,n){var l="*"+k+"*",m=l+"hooks";a.setGlobal(m,[]);this.COMMANDS[k]=Ymacs_Interactive("P",function(p){var o=this.getq(l);if(o){if(p!==true){this.getq(m).foreach(function(r){r.call(this,false)},this);if(o instanceof Function){o.call(this)}this.setq(l,null);this.modes.remove(k)}}else{if(p!==false){var q=n.apply(this,arguments);if(!(q instanceof Function)){q=true}this.setq(l,q);this.modes.push(k);this.getq(m).foreach(function(r){r.call(this,true)},this)}}return o})};a.addModeHook=d.addModeHook=function(k,m){if(typeof m=="string"){m=this.COMMANDS[m]}var l="*"+k+"*hooks";this.getq(l).pushUnique(m)};a.removeModeHook=d.removeModeHook=function(k,m){if(typeof m=="string"){m=this.COMMANDS[m]}var l="*"+k+"*hooks";this.getq(l).remove(m)};a.FIXARGS=function(k){if(k.code==null){k.code=""}};a.CONSTRUCT=function(){this.__savingExcursion=0;this.__preventUpdates=0;this.__preventUndo=0;this.__undoInProgress=0;this.__dirtyLines=[];this.__undoQueue=[];this.__redoQueue=[];this.__overlays={};this.markers=[];this.caretMarker=this.createMarker(0,false,"point");this.markMarker=this.createMarker(0,true,"mark");this.matchData=[];this.previousCommand=null;this.currentCommand=null;this.currentKeys=[];this.variables={};this.modes=[];this.caretMarker.onChange.push(function(k){this._rowcol=this.caretMarker.getRowCol();if(this.__preventUpdates==0){this.callHooks("onPointChange",this._rowcol,this.point())}});this._tokenizerEvents={onFoundToken:this._on_tokenizerFoundToken.$(this)};this._textProperties=new Ymacs_Text_Properties({buffer:this});this._textProperties.addEventListener("onChange",this._on_textPropertiesChange.$(this));this.keymap=[];this.pushKeymap(this.makeDefaultKeymap());this.setCode(this._code);this._lastCommandWasKill=0;delete this["_code"]};d.withVariables=function(o,k){var n={},m,l;for(m in o){n[m]=this.variables[m];this.variables[m]=o[m]}try{if(k instanceof Function){return k.apply(this,Array.$(arguments,2))}else{return this.cmdApply(k,Array.$(arguments,2))}}finally{for(m in n){if(n[m]===undefined){delete this.variables[m]}else{this.variables[m]=n[m]}}}};d.withCommands=function(l,k){var m=this.COMMANDS;this.COMMANDS=Object.makeCopy(m);Object.merge(this.COMMANDS,l);try{if(k instanceof Function){return k.apply(this,Array.$(arguments,2))}else{return this.cmdApply(k,Array.$(arguments,2))}}finally{this.COMMANDS=m}};d.getVariable=function(k){return(k in this.variables)?this.variables[k]:g[k]};d.setVariable=function(){return f.apply(this.variables,arguments)};a.setq=a.setVariable=a.setGlobal=d.setGlobal=function(){return f.apply(g,arguments)};d.setq=d.setVariable;d.getq=d.getVariable;a.getq=a.getVariable=function(k){return g[k]};d.pushKeymap=function(k){this.popKeymap(k);this.keymap.push(k);k.attached(this)};d.popKeymap=function(k){this.keymap.remove(k);k.detached(this)};d.makeDefaultKeymap=function(){return Ymacs_Keymap_Emacs()};d.signalError=function(l,k){this.callHooks("onMessage","error",l,k)};d.signalInfo=function(l,k){this.callHooks("onMessage","info",l,k)};d.createMarker=function(m,l,k){if(m==null){m=this.point()}return new Ymacs_Marker({editor:this,pos:m,name:k,before:l})};d.point=function(){return this.caretMarker.getPosition()};d.setCode=function(k){this.__code=k=k.replace(/\t/g," ".x(this.getq("tab_width")));this.__size=k.length;this.__undoQueue=[];this.__redoQueue=[];this.__overlays={};this.markers.map("setPosition",0,true,true);this.code=k.split(/\n/);this._textProperties.reset();if(this.tokenizer){this.tokenizer.reset()}this.callHooks("onResetCode",this.code);this.caretMarker.setPosition(0,false,true);this.markMarker.setPosition(0,true)};d.setTokenizer=function(k){if(this.tokenizer!=null){this.tokenizer.removeEventListener(this._tokenizerEvents)}this.tokenizer=k;if(k){k.addEventListener(this._tokenizerEvents)}else{this._textProperties.reset();this.callHooks("onResetCode",this.code)}};d.getCode=function(){return this.__code||(this.__code=this.code.join("\n"))};d.getCodeSize=function(){if(this.__size){return this.__size}var l=this.code.length,k=l>0?-1:0;while(--l>=0){k+=this.code[l].length+1}return this.__size=k};d.getLine=function(k){if(k==null){k=this._rowcol.row}return this.code[k]};d.charAtRowCol=function(m,l){var o=this.code.length;if(m>=o--){return null}var k=this.code[m];if(l==k.length){return m==o&&k.charAt(l)||"\n"}return k.charAt(l)};d.charAt=function(k){if(k==null){k=this.point()}else{k=j(k);if(k<0){k+=this.point()}}var l=this._positionToRowCol(k);return this.charAtRowCol(l.row,l.col)};d.callInteractively=function(m,k,o){var n;if(!(m instanceof Function)){n=m;m=this.COMMANDS[m]}else{n=m.ymacsCommand||null}this.currentCommand=n;if(n!="undo"){this.__undoQueue=this.__undoQueue.concat(this.__redoQueue);this.__redoQueue=[]}if(this.previousCommand!=n){this.sameCommandCount(0);if(n!="undo"){this._placeUndoBoundary()}}else{if(n!="self_insert_command"||this.sameCommandCount()%20==0){if(n!="undo"){this._placeUndoBoundary()}}}this.preventUpdates();try{this.callHooks("beforeInteractiveCommand");if(!m.ymacsMarkExtend){this.clearTransientMark()}if(m.ymacsCallInteractively&&!o){return m.ymacsCallInteractively.apply(this,k)}else{return m.apply(this,k)}}catch(l){if(l instanceof Ymacs_Exception){this.signalError(l.message)}else{throw l}}finally{this.resumeUpdates();this.callHooks("afterInteractiveCommand");this.previousCommand=n;this.sameCommandCount(+1);this.whenActiveFrame("ensureCaretVisible")}};d.resetOverwriteMode=function(k){if(arguments.length==0){k=this.overwriteMode}this.callHooks("onOverwriteMode",this.overwriteMode=!k);this.signalInfo(k?"Insert mode":"Overwrite mode")};d.getMinibuffer=function(){return this.whenYmacs(function(k){return k.minibuffer})};d.getMinibufferFrame=function(){return this.whenYmacs(function(k){return k.minibuffer_frame})};d.setMinibuffer=function(k){this.whenMinibuffer(function(l){l.setCode(k);l.cmd("end_of_buffer")})};d.cmd=function(k){return this.COMMANDS[k].apply(this,Array.$(arguments,1))};d.cmdApply=function(l,k){return this.COMMANDS[l].apply(this,k)};d.createDialog=function(k){if(!k.parent){k.parent=this.getActiveFrame()&&this.getActiveFrame().getParentDialog()}var l=new DlDialog(k);this.whenActiveFrame(function(m){l.addEventListener("onDestroy",m.focus.clearingTimeout(0,m))});return l};d.getActiveFrame=function(){return this.whenYmacs("getActiveFrame")};d.when=function(l,k){l=this[l]||this.getq(l);if(l!=null){if(k instanceof Function){return k.call(this,l)}else{return l[k].apply(l,Array.$(arguments,2))}}};d.whenActiveFrame=function(){var l=this.getActiveFrame();if(l.buffer===this){this.activeFrame=l;var k=Array.$(arguments);k.unshift("activeFrame");return this.when.apply(this,k)}else{this.activeFrame=null}};d.whenYmacs=function(){var k=Array.$(arguments);k.unshift("ymacs");return this.when.apply(this,k)};d.whenMinibuffer=function(k){return this.whenYmacs(function(l){if(l.minibuffer){return k.call(this,l.minibuffer)}})};d.preventUpdates=function(){++this.__preventUpdates};d.resumeUpdates=function(){if((this.__preventUpdates=Math.max(this.__preventUpdates-1,0))==0){this.redrawDirtyLines()}};d.getRegion=function(m,k){if(m==null){m=this.caretMarker}if(k==null){k=this.markMarker}m=j(m);k=j(k);if(k<m){var l=m;m=k;k=l}return{begin:m,end:k}};d.redrawDirtyLines=function(){this.__dirtyLines.foreach(function(k,l){if(k){this.callHooks("onLineChange",l)}},this);this.__dirtyLines=[]};d.getOverlays=function(){return this.__overlays};d.getOverlay=function(k){return this.__overlays[k]};d.setOverlay=function(l,o){var n=this.__overlays[l],k=!n,m;if(k){n=this.__overlays[l]=o}else{Object.merge(n,o)}if(n.line2<n.line1){m=n.line2;n.line2=n.line1;n.line1=m;m=n.col2;n.col2=n.col1;n.col1=m}else{if(n.line2==n.line1&&n.col2<n.col1){m=n.col2;n.col2=n.col1;n.col1=m}}this.callHooks("onOverlayChange",l,n,k)};d.deleteOverlay=function(k){delete this.__overlays[k];this.callHooks("onOverlayDelete",k)};d.ensureTransientMark=function(){var l=this._rowcol,k;if(!this.transientMarker){this.transientMarker=this.createMarker(this.point());this.markMarker.setPosition(this.point());k=l}if(!k){k=this.transientMarker.getRowCol()}this.setOverlay("selection",{line1:k.row,col1:k.col,line2:l.row,col2:l.col})};d.clearTransientMark=function(){if(this.transientMarker){this.transientMarker.destroy();this.transientMarker=null;this.deleteOverlay("selection")}};d.deleteTransientRegion=function(){if(this.transientMarker){this._deleteText(this.caretMarker,this.transientMarker);this.clearTransientMark();this._placeUndoBoundary();return true}};var c=0;d.sameCommandCount=function(k){if(k==null){return c}return c+=k};var i;d.interactiveEvent=function(k){if(arguments.length==0){return i}return i=k};d.getPrefixArg=function(l){var k=this.getq("universal_prefix");if(!l){this.setq("universal_prefix",undefined);if(!this.isMinibuffer){this.setMinibuffer("")}}return k};d.setPrefixArg=function(k){return this.setq("universal_prefix",k)};d._recordChange=function(l,o,k,n){if(k>0){var m=this.__undoQueue;m.push({type:l,pos:o,len:k,text:n});if(m.length>e){m.shift()}}};d._placeUndoBoundary=function(n){n=n||this.__undoQueue;var k=this.markers.map(function(o){return[o,o.getPosition()]});var l=n.peek();if(!l||l.type!=3){n.push({type:3,markers:k})}else{l.markers=k}};d._playbackUndo=function(m){++this.__undoInProgress;var k=false,l;while(m.length>0&&m.peek().type==3){l=m.pop()}while(m.length>0){l=m.pop();if(l.type==3){l.markers.foreach(function(o){o[0].setPosition(o[1])});break}k=true;var n=l.pos;switch(l.type){case 1:this._deleteText(n,n+l.len);break;case 2:this._insertText(l.text,n);break}}--this.__undoInProgress;return k};d._replaceLine=function(l,k){this.code[l]=k;this._textProperties.replaceLine(l,k);if(this.__preventUpdates==0){this.callHooks("onLineChange",l)}else{this.__dirtyLines[l]=true}};d._deleteLine=function(k){this.code.splice(k,1);this._textProperties.deleteLine(k);if(this.tokenizer){this.tokenizer.quickDeleteLine(k)}if(this.__preventUpdates!=0){this.__dirtyLines.splice(k,1,true)}this.callHooks("onDeleteLine",k)};d._insertLine=function(l,k){this.code.splice(l,0,k);this._textProperties.insertLine(l);if(this.tokenizer){this.tokenizer.quickInsertLine(l)}if(this.__preventUpdates==0){this.callHooks("onInsertLine",l,true)}else{this.__dirtyLines.splice(l,0,true);this.callHooks("onInsertLine",l)}};d._insertText=function(p,q){if(q==null){q=this.caretMarker.getPosition()}q=j(q);if(this.__preventUndo==0){this._recordChange(1,q,p.length)}var o=q==this.point()?this._rowcol:this._positionToRowCol(q),l=o.row;if(/^\n+$/.test(p)&&o.col==0){p.length.times(function(r){this._insertLine(l+r,"")},this)}else{var k=p.split(/\n/),n=this.code[l],m=n.substr(o.col);if(k.length>1){this._replaceLine(l,n.substr(0,o.col)+k.shift());k.foreach(function(r){this._insertLine(++l,r)},this);this._replaceLine(l,this.code[l]+m)}else{this._replaceLine(l,n.substr(0,o.col)+k[0]+n.substr(o.col))}}this._updateMarkers(q,p.length)};d._deleteText=function(o,m){o=this._boundPosition(j(o));m=this._boundPosition(j(m));if(m<o){var n=o;o=m;m=n}if(this.__preventUndo==0){this._recordChange(2,o,m-o,this._bufferSubstring(o,m))}var k=this._positionToRowCol(o),p=this._positionToRowCol(m);var l=this.code[k.row];if(k.row==p.row){l=l.substr(0,k.col)+l.substr(p.col);this._replaceLine(k.row,l)}else{l=l.substr(0,k.col)+this.code[p.row].substr(p.col);this._replaceLine(k.row,l);l=k.row+1;(p.row-k.row).times(this._deleteLine.$(this,l))}this._updateMarkers(o,o-m,o)};d._replaceText=function(l,k,m){this._deleteText(l,k);this._insertText(m,l)};d._swapAreas=function(k){k=k.map(j).mergeSort();var m=k[0],q=k[1],l=k[2],p=k[3],o=this._bufferSubstring(m,q),n=this._bufferSubstring(l,p);this._replaceText(l,p,o);this._replaceText(m,q,n);return p};d._bufferSubstring=function(m,k){if(m==null){m=this.point()}else{m=j(m)}if(k==null){k=this.getCodeSize()}else{k=j(k)}if(k<m){var l=m;m=k;k=l}return this.getCode().substring(m,k)};d._killingAction=function(o,m,k,l){o=j(o);m=j(m);var n=this._bufferSubstring(o,m);this._saveKilledText(n,k);if(!l){this._deleteText(o,m)}};d._saveKilledText=function(l,k){if(!this._lastCommandWasKill){this.ymacs.killRingToMaster()}this.ymacs.pushToKillRing(l,k);this._lastCommandWasKill++};d._positionToRowCol=function(m){var l=0;while(m>0&&l<this.code.length){var k=this.code[l].length;if(k>=m){break}m-=k+1;l++}return{row:l,col:m}};d._rowColToPosition=function(m,k){var p=0,l=Math.min(m,this.code.length-1),o=l;if(l<0){return 0}while(--l>=0){p+=this.code[l].length+1}return p+Math.min(k,this.code[o].length)};d._boundPosition=function(k){if(k<0){return 0}return Math.min(k,this.getCodeSize())};d._repositionCaret=function(l){var k=this.caretMarker.getPosition();if(l==null){l=k}l=j(l);l=this._boundPosition(l);this.caretMarker.setPosition(l);return l!=k};d._updateMarkers=function(l,m,k){this.__size=null;this.__code=null;if(this.__undoInProgress==0){this.markers.map("editorChange",l,m,k||0)}if(this.tokenizer){this.tokenizer.quickUpdate(Math.min(l,l+m))}};d._saveExcursion=function(k){var m=this.createMarker(this.point());++this.__savingExcursion;var l;try{return k.call(this)}finally{--this.__savingExcursion;this.caretMarker.swap(m,false,true);m.destroy()}};d._disableUndo=function(k){++this.__preventUndo;try{return k.call(this)}finally{--this.__preventUndo}};d._handleKeyEvent=function(n){var o=false;this.interactiveEvent(n);var m=this._lastCommandWasKill;if(this.__nextIsMeta){n.altKey=true}this.__nextIsMeta=false;var l=Ymacs_Keymap.unparseKey(n);var p=this.currentKeys;var k=false;p.push(l);this.keymap.r_foreach(function(r){var q=r.getHandler(p);if(q instanceof Array){this.callInteractively(q[0],q[1]);o=true}else{if(q){o=k=true}else{if(l==="ESCAPE"){this.__nextIsMeta=true;o=true}else{if(r.defaultHandler&&p.length==1){o=this.callInteractively(r.defaultHandler[0],r.defaultHandler[1])}}}}if(o){$BREAK()}},this);if(!k){if(!o){if(p.length>1){this.signalError(p.join(" ").bold()+" is undefined",true);o=true}}p.splice(0,p.length)}if(this._lastCommandWasKill==m&&typeof o!="object"){this._lastCommandWasKill=0}this.callHooks("finishedEvent",o);this.interactiveEvent(null);return o};d._centerOnCaret=function(){this.whenActiveFrame("centerOnCaret")};d._on_tokenizerFoundToken=function(n,l,k,m){if(m){this._textProperties.addLineProps(n,l,k,"css",m)}else{this._textProperties.removeLineProps(n,l,k,"css")}};d._on_textPropertiesChange=function(k){this.lastColoredLine=k;if(this.__preventUpdates==0){this.callHooks("onLineChange",k)}else{this.__dirtyLines[k]=true}};d.formatLineHTML=function(m,l){var k=this._rowcol;if(l instanceof Ymacs_Marker){k=l.getRowCol()}l=m==k.row?k.col:null;return this._textProperties.getLineHTML(m,this.code[m],l)}});DEFINE_CLASS("Ymacs_Marker",null,function(b,a){b.DEFAULT_ARGS={position:["pos",null],editor:["editor",null],before:["before",false],name:["name",null]};b.CONSTRUCT=function(){this.editor.markers.push(this);this.rowcol=null;this.onChange=[]};a.destroy=function(){this.editor.markers.remove(this);this.editor=null};a.editorChange=function(f,e,c){var d=this.position;if(this.before){--d}if(e!=0&&f<=d){this.rowcol=null;this.position+=e;if(this.position<c){this.position=c}this.callHooks(this.onChange,this.position)}};a.callHooks=function(d,c){for(var e=d.length;--e>=0;){d[e].call(this.editor,c)}};a.getPosition=function(){return this.position};a.setPosition=function(e,d,c){if(c||this.position!=e){this.rowcol=null;this.position=e;if(!d){this.callHooks(this.onChange,this.position)}}};a.getRowCol=function(){return this.rowcol||(this.rowcol=this.editor._positionToRowCol(this.position))};a.updateMarkers=function(c){this.editor._updateMarkers(this.getPosition(),c)};a.swap=function(c,f,e){var d=this.getPosition();this.setPosition(c.getPosition(),f,e);c.setPosition(d,f,e)}});Ymacs_Buffer.newCommands({forward_char:Ymacs_Interactive("p",function(a){if(a==null){a=1}return this.cmd("goto_char",this.point()+a)}),backward_char:Ymacs_Interactive("p",function(a){if(a==null){a=1}return this.cmd("forward_char",-a)}),forward_line:Ymacs_Interactive("p",function(a){if(a==null){a=1}var c=this._rowcol;if(!/^(forward|backward)_line$/.test(this.previousCommand)){this.setq("line_movement_requested_col",c.col)}var b=this.cmd("goto_char",this._rowColToPosition(c.row+a,Math.max(c.col,this.getq("line_movement_requested_col"))));if(!b){this.setq("line_movement_requested_col",c.col)}return b}),backward_line:Ymacs_Interactive("p",function(a){if(a==null){a=1}return this.cmd("forward_line",-a)}),forward_whitespace:Ymacs_Interactive("P",function(b){var a=b?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_forward_regexp",a)){this.cmd("backward_char");return true}else{if(!b){return this.cmd("end_of_buffer")}}}),backward_whitespace:Ymacs_Interactive("P",function(b){var a=b?/[^\x20\t\xA0]/g:/[^\s]/g;if(this.cmd("search_backward_regexp",a)){this.cmd("forward_char");return true}else{if(!b){return this.cmd("beginning_of_buffer")}}}),beginning_of_line:Ymacs_Interactive(function(){return this.cmd("goto_char",this._rowColToPosition(this._rowcol.row,0))}),back_to_indentation:Ymacs_Interactive(function(){var c=this._rowcol,b=this.code[c.row],a=/\S/.exec(b);if(a){return this.cmd("goto_char",this._rowColToPosition(c.row,a.index))}}),beginning_of_indentation_or_line:Ymacs_Interactive(function(){return this.cmd("back_to_indentation")||this.cmd("beginning_of_line")}),end_of_line:Ymacs_Interactive(function(){var a=this._rowcol;return this.cmd("goto_char",this._rowColToPosition(a.row,this.code[a.row].length))}),beginning_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",0)}),end_of_buffer:Ymacs_Interactive(function(){return this.cmd("goto_char",this.getCodeSize())}),eob_p:function(){return this.point()==this.getCodeSize()},bob_p:function(){return this.point()==0},backward_delete_char:Ymacs_Interactive("^p",function(b){if(!this.deleteTransientRegion()){if(b==null){b=1}var a=this.point();if(a>0){this._deleteText(a-b,a)}}}),delete_char:Ymacs_Interactive("^p",function(b){if(!this.deleteTransientRegion()){if(b==null){b=1}var a=this.point();this._deleteText(a,a+b)}}),delete_whitespace:Ymacs_Interactive("^P",function(a){if(!this.deleteTransientRegion()){var b=this.point();if(this.cmd("forward_whitespace",a)){this._deleteText(b,this.point());return true}}}),backward_delete_whitespace:Ymacs_Interactive("^P",function(a){if(!this.deleteTransientRegion()){var b=this.point();if(this.cmd("backward_whitespace",a)){this._deleteText(this.point(),b);return true}}}),universal_argument:Ymacs_Interactive("^",function(){this.pushKeymap(Ymacs_Keymap_UniversalArgument());if(!this.isMinibuffer){this.setMinibuffer("C-u")}}),overwrite_mode:Ymacs_Interactive(function(){this.resetOverwriteMode()}),self_insert_command:Ymacs_Interactive("^p",function(d){var b=this.interactiveEvent(),a=String.fromCharCode(b.charCode),c=this._rowcol;if(b.charCode&&a&&!b.altKey&&!b.ctrlKey){this.deleteTransientRegion();if(d!=null){a=a.x(d)}this.cmd("insert",a);b.domStop=true;return true}return false}),newline:Ymacs_Interactive("^p",function(a){if(a==null){a=1}this.deleteTransientRegion();this.cmd("insert","\n".x(a))}),newline_and_indent:Ymacs_Interactive("p",function(a){if(a==null){a=1}a.times(function(b){if(b>0){this.cmd("forward_line")}this.cmd("backward_delete_whitespace",true);this.cmd("newline");this.cmd("indent_line")},this)}),indent_line:Ymacs_Interactive("P",function(b){if(this.tokenizer){var a=this.tokenizer.getIndentation(this._rowcol.row);if(a!=null){if(!b||/\S/.test(this.getLine())){var c=this.cmd("save_excursion",function(){this.cmd("back_to_indentation");if(this._rowcol.col!=a){this.cmd("beginning_of_line");this.cmd("delete_whitespace",true);this.cmd("insert"," ".x(a))}return this.point()});if(this.point()<c){this.cmd("goto_char",c)}}return}}this.cmd("insert"," ".x(this.getq("indent_line")))}),indent_region:Ymacs_Interactive("r",function(c,a){if(a<c){var b=c;c=a;a=b}this.cmd("save_excursion",function(){var d=this.createMarker(a);this.cmd("goto_char",c);while(this.point()<d.getPosition()){this.cmd("indent_line",true);this.cmd("beginning_of_line");if(!this.cmd("forward_line")){break}}})}),make_marker:function(a){return this.createMarker(a)},looking_at:function(b){var c=b.lastIndex=this.point();var a=this.matchData=b.exec(this.getCode());if(a){a.after=b.lastIndex}return a&&a.index==c},looking_back:function(b){var a=this.lastIndexOfRegexp(this.getCode(),b,this.point());return a&&a.after==this.point()},search_forward:Ymacs_Interactive("sSearch: ",function(c){var b=this.getCode(),a=this.point();if(this.getq("case_fold_search")){b=b.toLowerCase();c=c.toLowerCase()}var d=b.indexOf(c,a);if(d>=0){this.cmd("goto_char",d+c.length);return true}}),search_backward:Ymacs_Interactive("sSearch backward: ",function(c){var b=this.getCode(),a=this.point();if(this.getq("case_fold_search")){b=b.toLowerCase();c=c.toLowerCase()}var d=b.lastIndexOf(c,a);if(d==a){d=b.lastIndexOf(c,a-1)}if(d>=0&&d!=a){this.cmd("goto_char",d);return true}}),make_regexp:function(c){if(!(c instanceof RegExp)){var b=c.toLowerCase()!=c.toUpperCase();try{c=new RegExp(c,b?"ig":"g")}catch(a){throw new Ymacs_Exception("Invalid regexp")}}return c},search_forward_regexp:Ymacs_Interactive("sRegExp search: ",function(c){c=this.cmd("make_regexp",c);var b=this.getCode(),d=c.lastIndex=this.point(),a=this.matchData=c.exec(b);if(a&&c.lastIndex!=d){a.after=c.lastIndex;this.cmd("goto_char",c.lastIndex);return true}}),search_backward_regexp:Ymacs_Interactive("sBackward RegExp search: ",function(b){b=this.cmd("make_regexp",b);var a=this.lastIndexOfRegexp(this.getCode(),b,this.point());if(a&&a.index!=this.point()){this.cmd("goto_char",a.index);return true}}),forward_word:Ymacs_Interactive_X(function(){var b=this.getq("syntax_word"),a=false;while(!a&&!b.test(this.charAt())){if(!this.cmd("forward_char")){a=true}}while(!a&&b.test(this.charAt())){if(!this.cmd("forward_char")){a=true}}}),backward_word:Ymacs_Interactive_X(function(){var b=this.getq("syntax_word"),a=false;while(!a&&!b.test(this.charAt(-1))){if(!this.cmd("backward_char")){a=true}}while(!a&&b.test(this.charAt(-1))){if(!this.cmd("backward_char")){a=true}}}),forward_paragraph:Ymacs_Interactive_X(function(){this.cmd("forward_whitespace");if(this.cmd("search_forward_regexp",this.getq("syntax_paragraph_sep"))){this.cmd("goto_char",this.cmd("match_beginning")+1)}else{this.cmd("end_of_buffer")}}),backward_paragraph:Ymacs_Interactive_X(function(){this.cmd("backward_whitespace");if(this.cmd("search_backward_regexp",this.getq("syntax_paragraph_sep"))){this.cmd("goto_char",this.cmd("match_end")-1)}else{this.cmd("beginning_of_buffer")}}),transpose_words:Ymacs_Interactive_X(function(){this.cmd("backward_char");if(this.getq("syntax_word").test(this.charAt())){this.cmd("forward_word")}var b=[];this.cmd("forward_word");b.push(this.point());this.cmd("backward_word");b.push(this.point());this.cmd("backward_word");b.push(this.point());this.cmd("forward_word");b.push(this.point());this.cmd("goto_char",this._swapAreas(b))}),transpose_lines:Ymacs_Interactive_X(function(){var b=[];this.cmd("backward_line");this.cmd("beginning_of_line");b.push(this.point());this.cmd("end_of_line");b.push(this.point());this.cmd("forward_char");b.push(this.point());this.cmd("end_of_line");b.push(this.point());this.cmd("goto_char",this._swapAreas(b)+1)}),transpose_chars:Ymacs_Interactive_X(function(){var a=this.point();if(this.cmd("backward_char")){this.cmd("goto_char",this._swapAreas([a-1,a,a,a+1]))}}),kill_word:Ymacs_Interactive_X(function(){var b=this.point();this.cmd("forward_word");var a=this.point();this._killingAction(b,a,false)}),backward_kill_word:Ymacs_Interactive_X(function(){var b=this.point();this.cmd("backward_word");var a=this.point();this._killingAction(b,a,true)}),_apply_operation_on_word:function(e,d){var c=this.point();if(this.getq("syntax_word").test(this.charAt())){var a=this.cmd("save_excursion",function(){this.cmd("forward_word");return this.point()});var b=e.call(this._bufferSubstring(c,a));this._deleteText(c,a);this._insertText(b)}else{this.cmd("forward_word");this.cmd("backward_word");if(c!=this.point()){this.cmd(d)}}},capitalize_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",function(){return this.charAt(0).toUpperCase()+this.substr(1).toLowerCase()},"capitalize_word")}),downcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toLowerCase,"downcase_word")}),upcase_word:Ymacs_Interactive_X(function(){this.cmd("_apply_operation_on_word",String.prototype.toUpperCase,"upcase_word")}),goto_char:Ymacs_Interactive("NGoto char: ",function(a){return this._repositionCaret(a)}),goto_line:Ymacs_Interactive("NGoto line: ",function(a){var b=this._rowColToPosition(a-1,0);return this.cmd("goto_char",b)}),insert:function(){return this._insertText(Array.$(arguments).join(""))},buffer_substring:function(b,a){if(arguments.length==0){var c=this.getRegion();b=c.begin;a=c.end}return this._bufferSubstring(b,a)},kill_line:Ymacs_Interactive_X(function(){var d=this.point(),c=this._rowcol,b=this.code[c.row],a=d+b.length-c.col;if(c.row<this.code.length-1&&this.cmd("looking_at",/\s*$/mg)){a++}this._killingAction(d,a)}),save_excursion:function(){return this._saveExcursion.apply(this,arguments)},prevent_undo:function(){return this._disableUndo.apply(this,arguments)},point:function(){return this.caretMarker.getPosition()},kill_region:Ymacs_Interactive("r",function(b,a){this._killingAction(b,a)}),copy_region_as_kill:Ymacs_Interactive("r",function(b,a){this._killingAction(b,a,false,true)}),yank:Ymacs_Interactive("P",function(b){var a=this.point();this._insertText(this.ymacs.killRingText());this.cmd("set_mark_command",a);if(b){this.cmd("exchange_point_and_mark")}}),yank_pop:Ymacs_Interactive(function(){if(/^yank/.test(this.previousCommand)){this.ymacs.rotateKillRing(false);this._deleteText(this.caretMarker,this.markMarker);this.cmd("yank")}else{this.signalError("Previous command was not a yank")}}),yank_shift:Ymacs_Interactive(function(){if(/^yank/.test(this.previousCommand)){this.ymacs.rotateKillRing(true);this._deleteText(this.caretMarker,this.markMarker);this.cmd("yank")}else{this.signalError("Previous command was not a yank")}}),mark:function(){return this.markMarker.getPosition()},set_mark_command:Ymacs_Interactive("d",function(a){this.markMarker.setPosition(a)}),exchange_point_and_mark:Ymacs_Interactive("^",function(){this.caretMarker.swap(this.markMarker)}),mark_whole_buffer:Ymacs_Interactive(function(){this.clearTransientMark();this.cmd("end_of_buffer");this.ensureTransientMark();this.cmd("beginning_of_buffer");this.ensureTransientMark()}),recenter_top_bottom:Ymacs_Interactive(function(){this._centerOnCaret()}),fill_paragraph:Ymacs_Interactive("P",function(a){this.cmd("save_excursion",function(){if(!this.cmd("looking_at",this.getq("syntax_paragraph_sep"))){this.cmd("forward_paragraph")}var c=this.createMarker(this.point()-1);this.cmd("backward_paragraph");if(this.point()>0){this.cmd("forward_char")}var d="",b=false;if(this.cmd("looking_at",/\s*([-]|[0-9]+\.|\(?[a-z][\).])?\s+/ig)){d=" ".x(this.matchData[0].length);b=/\s*[#>;\s]*\s*/g}else{if(this.cmd("looking_at",/\s*[#>;*\s]+\s*/g)){d=this.matchData[0];b=/\s*[#>;\s]*\s*/g}}if(a){this._deleteText(this.point(),this.point()+this.matchData[0].length);d=""}while(true){this.cmd("end_of_line");this.cmd("backward_delete_whitespace");if(this.point()>=c.getPosition()){break}this._replaceText(this.point(),this.point()+1," ");if(b&&this.cmd("looking_at",b)){this._deleteText(this.point(),this.point()+this.matchData[0].length)}}this.cmd("beginning_of_line");while(this.point()<c.getPosition()){var e=this.point();if(!this.cmd("search_forward_regexp",/\s/g)){break}if(this.point()>c.getPosition()){this.cmd("goto_char",c)}if(this._rowcol.col>this.getq("fill_column")){this.cmd("goto_char",e);this.cmd("backward_delete_whitespace");this.cmd("newline");this.cmd("insert",d)}}c.destroy();this.cmd("recenter_top_bottom")})}),fill_paragraph_no_prefix:Ymacs_Interactive(function(){return this.cmd("fill_paragraph",true)}),start_next_paragraph:Ymacs_Interactive(function(){this.cmd("backward_paragraph");if(this.point()>0){this.cmd("forward_char")}var a="";if(this.cmd("looking_at",/(\s*)([0-9]+)(\.\s+)/g)){a=this.matchData[1]+(parseInt(this.matchData[2],10)+1)+this.matchData[3]}else{if(this.cmd("looking_at",/(\s*\(?)([a-z])([\.\)]\s+)/ig)){a=this.matchData[1]+String.fromCharCode(this.matchData[2].charCodeAt(0)+1)+this.matchData[3]}else{if(this.cmd("looking_at",/\s*[#>;*\s-]+\s*/g)){a=this.matchData[0]}}}this.cmd("forward_paragraph");if(this.cmd("eob_p")){this.cmd("newline")}this.cmd("insert","\n",a);if(!this.cmd("looking_at",/\n\n/g)){this.cmd("newline");this.cmd("backward_char")}}),scroll_down:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(b){var a=b.heightInLines();this.cmd("forward_line",Math.round(a/1.33));this.cmd("recenter_top_bottom")})}),scroll_up:Ymacs_Interactive_X(function(){this.whenActiveFrame(function(b){var a=b.heightInLines();this.cmd("backward_line",Math.round(a/1.33));this.cmd("recenter_top_bottom")})}),nuke_trailing_whitespace:Ymacs_Interactive(function(){this.cmd("save_excursion",function(){this.cmd("goto_char",0);while(this._rowcol.row<this.code.length){var b=this.code[this._rowcol.row],a=/\s+$/.exec(b);if(a){this.cmd("beginning_of_line");this._deleteText(this.point()+a.index,this.point()+b.length)}if(!this.cmd("forward_line")){break}}})}),match_string:function(a){return this.matchData[a]},match_beginning:function(){return this.matchData.index},match_end:function(){return this.matchData.index+this.matchData[0].length},undo:Ymacs_Interactive_X(function(){var a=this.__undoQueue;this.__undoQueue=this.__redoQueue;this._placeUndoBoundary();if(!this._playbackUndo(a)){this.signalError("No further undo information")}this.__undoQueue=a}),center_line:Ymacs_Interactive("p",function(a){if(a==null){a=1}a.times(function(b){if(b>0){this.cmd("forward_line")}this.cmd("save_excursion",function(){this.cmd("end_of_line");this.cmd("backward_delete_whitespace",true);this.cmd("beginning_of_line");this.cmd("delete_whitespace",true);var d=this.code[this._rowcol.row];var c=Math.floor((this.getq("fill_column")-d.length)/2);this.cmd("insert"," ".x(c))})},this)}),dabbrev_expand:Ymacs_Interactive_X(function(){if(this.previousCommand!="dabbrev_expand"){this.setq("dabbrev_context",null)}var a=this.getq("dabbrev_context");if(!a){a=this.setq("dabbrev_context",{});var d=this.cmd("save_excursion",function(){this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"backward_word");return this.point()});if(d==this.point()){return this.signalError("Nothing to expand")}a.search=this.cmd("buffer_substring",d,this.point());a.point=d;a.length=this.point()-d;a.lastSearch=d;a.encountered={};a.forward=false;a.buffer=this;a.startBuffer=this}var b;a.buffer.cmd("save_excursion",function c(){var f=this.getq("syntax_word_dabbrev");var g;var e=false;this.cmd("goto_char",a.lastSearch);if(!a.forward){while(this.cmd("search_backward",a.search)){if(!f.test(this.charAt(-1))){e=true;break}}if(e){g=this.point();a.lastSearch=g;this.cmd("goto_char",g+a.search.length)}else{a.forward=true;a.lastSearch=a.point+a.length;c.call(this);return}}else{while(this.cmd("search_forward",a.search)){if(!f.test(this.charAt(-a.search.length-1))){e=true;break}}if(e){a.lastSearch=this.point();g=this.point()-a.search.length}else{a.buffer=this.whenYmacs("getNextBuffer",this);if(a.buffer===a.startBuffer){b=a.search;a.startBuffer.signalError("No more completions");a.lastSearch=a.point+a.length;a.startBuffer.setq("dabbrev_context",null);return}else{a.lastSearch=0;a.buffer.cmd("save_excursion",c);return}}}if(g!=null){this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"forward_word");b=this.cmd("buffer_substring",g,this.point());if(b in a.encountered){c.call(this)}}});if(b!=null){this._replaceText(a.point,a.point+a.length,b);a.length=b.length;a.encountered[b]=true}}),split_frame_vertically:Ymacs_Interactive(function(){this.whenActiveFrame("vsplit")}),split_frame_horizontally:Ymacs_Interactive(function(){this.whenActiveFrame("hsplit")}),delete_other_frames:Ymacs_Interactive(function(){this.whenActiveFrame("deleteOtherFrames")}),other_frame:Ymacs_Interactive(function(){this.whenYmacs("focusOtherFrame")}),next_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToNextBuffer",this.sameCommandCount()+1)}),previous_buffer:Ymacs_Interactive(function(){this.whenYmacs("switchToPreviousBuffer",this.sameCommandCount()+1)}),switch_to_buffer:Ymacs_Interactive("BSwitch to buffer: ",function(a){this.whenYmacs(function(b){b.switchToBuffer(a)})}),kill_buffer:Ymacs_Interactive(function(){this.whenYmacs(function(a){a.killBuffer(this)})}),rename_buffer:Ymacs_Interactive("sRename current buffer to: ",function(a){this.whenYmacs(function(b){b.renameBuffer(this,a)})}),delete_region_or_line:Ymacs_Interactive("^",function(){if(!this.deleteTransientRegion()){this.cmd("beginning_of_line");var a=this.point();if(this.cmd("forward_line")||this.cmd("end_of_line")){this._deleteText(a,this.point());return true}}}),close_last_xml_tag:Ymacs_Interactive_X(function(){var a,b;this.cmd("save_excursion",function(){var c=1;while(c!=0&&this.cmd("search_backward_regexp",/<\x2f?([a-zA-Z0-9:_-]+)/g)){a=this.cmd("match_string",1);if(this.cmd("looking_at",/<\x2f/g)){++c}else{if(!this.cmd("looking_at",/<[^\x2f][^>]*?\x2f>/g)){--c}}}if(c!=0){a=null}});if(a){this.cmd("insert","</",a,">")}else{throw new Ymacs_Exception("Couldn't find a tag to close")}}),bind_variables:function(){return this.withVariables.apply(this,arguments)},for_region:Ymacs_Interactive("^r\nCExecute command within region: ",function(c,a,d){if(a<c){var b=c;c=a;a=b}if(!(d instanceof Function)){d=this.COMMANDS[d]}this.clearTransientMark();this.cmd("goto_char",c);c=this.createMarker(c,true);a=this.createMarker(a);this.withCommands({goto_char:function(e){if(e>=c.getPosition()&&e<=a.getPosition()){return this._repositionCaret(e)}throw"YMACS_RESTRICT"}},function(){try{while(true){var f=this.point();d.call(this);if(this.point()==f&&!this.cmd("forward_line")){break}}}catch(e){if(e!=="YMACS_RESTRICT"){throw e}}finally{c.destroy();a.destroy()}})})});(function(){function a(f,e,b){var d=this.createDialog({title:f,quitBtn:"destroy",modal:true});var c=new DlEntry({parent:d,type:"textarea",fillParent:true,value:e});d._focusedWidget=c;d.setSize({x:350,y:250});c.addEventListener("onKeyPress",function(h){if(h.keyCode!=DlKeyboard.ESCAPE){var g=c.getValue().replace(/\t/g,"        ");d.destroy();b.delayed(0,this,g)}}.clearingTimeout(0,this));d.show(true);c.select()}Ymacs_Buffer.newCommands({yank_from_operating_system:Ymacs_Interactive(function(){a.call(this,"Paste below (press CTRL-V)",null,function(b){this._saveKilledText(b);this.cmd("yank");this.cmd("recenter_top_bottom")})}),copy_for_operating_system:Ymacs_Interactive("r",function(c,b){a.call(this,"Press CTRL-C",this.cmd("buffer_substring"),function(){this.cmd("copy_region_as_kill",c,b)})}),kill_for_operating_system:Ymacs_Interactive("r",function(c,b){a.call(this,"Press CTRL-C or CTRL-X",this.cmd("buffer_substring"),function(){this.cmd("kill_region",c,b)})})})})();["forward_char","forward_word","forward_line","forward_paragraph","forward_sexp","beginning_of_line","beginning_of_indentation_or_line","beginning_of_buffer","backward_char","backward_word","backward_line","backward_paragraph","backward_sexp","end_of_line","end_of_buffer"].foreach(function(a){Ymacs_Buffer.COMMANDS[a+"_mark"]=Ymacs_Interactive("^",function(){this.ensureTransientMark();this.cmdApply(a,arguments);this.ensureTransientMark()})});Ymacs_Buffer.newCommands({get_region:function(){return this.getRegion()},cperl_lineup:Ymacs_Interactive("r",function(b,a){this.cmd("save_excursion",function(){var e=this._positionToRowCol(a),c=0,d=[];this.cmd("goto_char",b);this.cmd("forward_whitespace",true);var f=this.charAt();if(f.toLowerCase()!=f.toUpperCase()){this.signalError("Cannot lineup here");return}while(this._rowcol.row<=e.row){var g=this.getLine().indexOf(f);if(g>=0){if(g>c){c=g}d.push([this._rowcol.row,g])}if(!this.cmd("forward_line")){break}}++c;d.foreach(function(h){this.cmd("goto_char",this._rowColToPosition(h[0],h[1]));this.cmd("insert"," ".x(c-h[1]))},this)})}),htmlize_region:Ymacs_Interactive("r\nP",function(e,b,h){this.tokenizer.finishParsing();var g=this._positionToRowCol(e).row,d=String.buffer(),a=g,f;if(h&&!h.empty){a=parseInt(h,10)}b=this._positionToRowCol(b).row;f=String(b).length;while(g<=b){d("<div class='line'>");if(h){d("<span class='line-number'>",a.zeroPad(f," "),"</span>")}++a;d(this._textProperties.getLineHTML(g,this.code[g],null),"</div>\n");++g}d=d.get();var c=this.ymacs.switchToBuffer("*Htmlize*");c.setCode(d);c.cmd("xml_mode",true)}),execute_extended_command:Ymacs_Interactive("^CM-x ",function(a){this.callInteractively(a)}),eval_region:Ymacs_Interactive("^r",function(c,a){var d=this.cmd("buffer_substring",c,a);try{d=new Function("buffer",d);d.call(this,this);this.clearTransientMark()}catch(b){this.signalError(b.name+": "+b.message);if(window.console){console.log(b)}}}),toggle_line_numbers:Ymacs_Interactive("^",function(){this.whenActiveFrame("toggleLineNumbers")})});DEFINE_CLASS("Ymacs_Keymap",null,function(b,a){var c={};Object.foreach(DlKeyboard,function(e,d){if(typeof e=="number"){c[e]=d}});b.CONSTRUCT=function(){this.definitions=Object.makeCopy(this.__originalDefs)};a.FINISH_OBJECT_DEF=function(){this.__originalDefs={};var d=this.constructor.KEYS;if(d){this.defineKeys(d)}};a.parseKey=function(f){var e={};var d=f.split(/-/);d.reverse();d.foreach(function(j,h){if(h==0){if(typeof DlKeyboard[j]=="number"){e.keyCode=DlKeyboard[j]}else{d[h]=j.toLowerCase();e.charCode=d[h].charCodeAt(0)}}else{switch(j){case"C":e.ctrlKey=true;break;case"M":e.metaKey=true;break;case"S":e.shiftKey=true;break}}});d.reverse();var g=d.pop();e.str=d.sort().join("-");if(e.str){e.str+="-"}e.str+=g;return e};b.unparseKey=function(f){var e,d=[];if(f.keyCode in c){e=c[f.keyCode]}else{if(f.charCode){if(f.charCode==32){e="SPACE"}else{if(f.charCode==45){e="DASH"}else{e=String.fromCharCode(f.charCode).toLowerCase()}}}}if(f.ctrlKey){d.push("C")}if(f.altKey){d.push("M")}if(f.shiftKey&&(f.charCode&&/^[a-zA-Z0-9]$/.test(e)||f.keyCode)){d.push("S")}d.sort();d=d.join("-");if(d){d+="-"}return d+e};a.defineKey=function(g,h,f){if(h instanceof Array){f=h.slice(1);h=h[0]}g=g.trim().split(/\s*&&\s*/);if(g.length>1){g.foreach(function(i){this.defineKey(i,h,f)},this)}else{g=g[0].trim();var e=this.definitions||this.__originalDefs;if(g.indexOf(" ")>=0){var d=g.split(/\s+/);g=d.pop();d.foreach(function(i){i=this.parseKey(i).str;if(!e[i]){e[i]={}}e=e[i]},this)}g=this.parseKey(g);e[g.str]=[h,f]}};a.defineKeys=function(d){Object.foreach(d,function(f,e){this.defineKey(e,f)},this)};a.getHandler=function(e){var d=null,f=this.definitions;e.foreach(function(h){var g=d?d[h]:f[h];if(g){d=g;if(d instanceof Array){$BREAK()}}else{if(d){d=null;$BREAK()}}});return d};a.attached=Function.noop;a.detached=Function.noop});DEFINE_SINGLETON("Ymacs_Keymap_Emacs",Ymacs_Keymap,function(b,a){var c=String.template("<table>","<tr><td style='text-align: right; font-weight: bold'>Char:</td><td><tt> $ch </tt></td></tr>","<tr><td style='text-align: right; font-weight: bold'>Char code:</td><td> $code / 0x$codeHex </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Position:</td><td> $point </td></tr>","<tr><td style='text-align: right; font-weight: bold'>Buffer size:</td><td> $sizeKB </td></tr>","</table>");b.KEYS={"ARROW_UP     && C-p":"backward_line","ARROW_DOWN   && C-n":"forward_line","ARROW_LEFT   && C-b":"backward_char","ARROW_RIGHT  && C-f":"forward_char",HOME:"beginning_of_indentation_or_line","END && C-e":"end_of_line","C-a":"beginning_of_line","C-HOME && M-<":"beginning_of_buffer","C-END && M->":"end_of_buffer","C-ARROW_RIGHT && M-f":"forward_word","C-ARROW_LEFT && M-b":"backward_word","C-ARROW_DOWN":"forward_paragraph","C-ARROW_UP":"backward_paragraph","C-l":"recenter_top_bottom","PAGE_UP && M-v":"scroll_up","PAGE_DOWN && C-v":"scroll_down","S-ARROW_UP       && S-C-p":"backward_line_mark","S-ARROW_DOWN     && S-C-n":"forward_line_mark","S-ARROW_LEFT     && S-C-b":"backward_char_mark","S-ARROW_RIGHT    && S-C-f":"forward_char_mark","S-C-ARROW_RIGHT  && S-M-f":"forward_word_mark","S-C-ARROW_LEFT   && S-M-b":"backward_word_mark","S-C-ARROW_DOWN":"forward_paragraph_mark","S-C-ARROW_UP":"backward_paragraph_mark","S-HOME":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-END":"end_of_line_mark","S-C-HOME":"beginning_of_buffer_mark","S-C-END":"end_of_buffer_mark",BACKSPACE:"backward_delete_char","DELETE && C-d":"delete_char","ENTER && C-m":"newline","M-d":"kill_word","C-BACKSPACE && M-BACKSPACE && M-DELETE":"backward_kill_word","C-k":"kill_line","C-y && S-INSERT":"yank","M-y":"yank_pop","C-SPACE":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","C-x C-t":"transpose_lines","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace",TAB:"indent_line","C-M-\\":"indent_region","M-q":"fill_paragraph","C-/ && C-x u && C-_ && C-z":"undo",INSERT:"overwrite_mode","M-s":"center_line","M-/":"dabbrev_expand","C-s":"isearch_forward","C-r":"isearch_backward","M-C-s":"isearch_forward_regexp","M-C-r":"isearch_backward_regexp","C-u":"universal_argument","M-g":"goto_line","C-x h":"mark_whole_buffer","C-x C-ARROW_RIGHT && C-x ARROW_RIGHT && C-TAB":"next_buffer","C-x C-ARROW_LEFT && C-x ARROW_LEFT && C-S-TAB":"previous_buffer","C-x b":"switch_to_buffer","C-x k":"kill_buffer","C-x 1":"delete_other_frames","C-x 2":"split_frame_vertically","C-x 3":"split_frame_horizontally","C-x o":"other_frame","C-x l":"toggle_line_numbers","M-x":"execute_extended_command","C-S-y":"yank_from_operating_system","M-S-w":"copy_for_operating_system","C-S-w":"kill_for_operating_system","M-C-d":"delete_region_or_line","M-S-y":"yank_shift","C-c /":"close_last_xml_tag","S-BACKSPACE":"backward_delete_whitespace","S-DELETE":"delete_whitespace","M-ENTER":"start_next_paragraph","M-S-q":"fill_paragraph_no_prefix","C-M-|":"cperl_lineup","C-x =":function(){var e=this.charAt(),d=e;if(e==" "){d="<SPACE>"}else{if(e=="\n"){d="<NEWLINE>"}else{if(e=="-"){d="<DASH>"}}}this.signalInfo(c({ch:d.htmlEscape(),code:e.charCodeAt(0),codeHex:e.charCodeAt().hex(),point:this.point(),size:this.getCodeSize(),sizeKB:this.getCodeSize().formatBytes(2)}),true)}};a.defaultHandler=["self_insert_command"]});DEFINE_SINGLETON("Ymacs_Keymap_UniversalArgument",Ymacs_Keymap,function(b,a){a.defaultHandler=[Ymacs_Interactive("^",function(){var d=this.interactiveEvent(),c=String.fromCharCode(d.charCode),e=this.getPrefixArg(true);if(d.charCode&&(/^[0-9]$/.test(c)||(c==="-"&&e===""))&&!d.altKey&&!d.ctrlKey){e+=c;this.setPrefixArg(e);if(!this.isMinibuffer){this.whenMinibuffer(function(f){f.cmd("insert"," ",c)})}return true}this.popKeymap(Ymacs_Keymap_UniversalArgument());return false})];a.attached=function(c){c.setPrefixArg("")}});DEFINE_SINGLETON("Ymacs_Keymap_ISearch",Ymacs_Keymap,function(f,e){f.KEYS={"C-g && ESCAPE":["isearch_abort",true],"C-w":"isearch_yank_word_or_char","C-s":"isearch_forward","C-r":"isearch_backward",BACKSPACE:function(){if(this.getMinibuffer().point()>this._isearchContext.mbMark.getPosition()){this.getMinibuffer().cmd("backward_delete_char");this.cmd("goto_char",this._isearchContext.point);c.call(this,this._isearchContext.forward)}},ENTER:"isearch_abort"};f.CONSTRUCT=function(){this.defaultHandler=["isearch_printing_char"]};function d(g){if(!this._isearchContext){this.pushKeymap(Ymacs_Keymap_ISearch());this.cmd("set_mark_command",this.point());this.setMinibuffer(g?"I-Search: ":"I-Search backward: ");this._isearchContext={forward:g,point:this.point(),mbMark:this.getMinibuffer().createMarker(null,true)};return true}}function c(g){this._isearchContext.forward=g;this._isearchContext.point=this.point();var h=a(this);if(!/\S/.test(h)&&this._isearchLastText){this.getMinibuffer()._placeUndoBoundary();this.getMinibuffer().cmd("insert",this._isearchLastText);h=this._isearchLastText}return b.call(this,h)}function b(h){if(h==null){h=a(this)}var g=this.cmd("bind_variables",{case_fold_search:h==h.toLowerCase()},this.cmd,this._isearchContext.forward?"search_forward":"search_backward",h);if(g){this.cmd("recenter_top_bottom")}return g}function a(g){return g.cmd("isearch_get_search_text")}Ymacs_Buffer.newCommands({isearch_get_search_text:Ymacs_Interactive(function(){if(this._isearchContext){return this.getMinibuffer()._bufferSubstring(this._isearchContext.mbMark)}}),isearch_forward:Ymacs_Interactive(function(){if(!d.call(this,true)){if(!c.call(this,true)){this.signalError("No more forward occurrences of the search text")}}}),isearch_forward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward_regexp:Ymacs_Interactive(function(){this.signalError("Not implemented, but should be easy.  Volunteers?")}),isearch_backward:Ymacs_Interactive(function(){if(!d.call(this,false)){if(!c.call(this,false)){this.signalError("No more backward occurrences of the search text")}}}),isearch_yank_word_or_char:Ymacs_Interactive(function(){var i=this.point();this.cmd("forward_word");var g=this.point();if(g!=i){var h=this._bufferSubstring(i,g);this.getMinibuffer()._placeUndoBoundary();this.getMinibuffer().cmd("insert",h.toLowerCase())}}),isearch_printing_char:Ymacs_Interactive(function(){var g=this.interactiveEvent();if(g.charCode&&!g.ctrlKey&&!g.altKey){this.getMinibuffer().cmd("self_insert_command");var h=a(this);this.cmd("goto_char",this._isearchContext.point);b.call(this,h);return g.domStop=true}else{if(g.keyCode!=0||g.ctrlKey||g.altKey){this.cmd("isearch_abort");return false}}}),isearch_abort:Ymacs_Interactive(function(g){if(!g){this._isearchLastText=a(this)}this.setMinibuffer("");this.popKeymap(Ymacs_Keymap_ISearch());this._isearchContext.mbMark.destroy();this._isearchContext=null;if(g){this.cmd("exchange_point_and_mark")}return true})})});Ymacs_Buffer.newMode("minibuffer_mode",function(){var b=this.createMarker(0,true);var a=this.setq({minibuffer_end_marker:b});var c=Ymacs_Keymap_Minibuffer();this.pushKeymap(c);return function(){this.setq(a);b.destroy();this.popKeymap(c)}});(function(){var k=false;var a=null,i=null;function l(o,n){if(a){a.destroy()}a=new DlVMenu({});n.foreach(function(p){new DlMenuItem({parent:a,label:p.htmlEscape(),data:p})});var m=Ymacs_Completion_Popup.get();m.popup({timeout:0,content:a,align:{prefer:"Tr",fallX1:"_r",fallX2:"_L",fallY1:"B_",fallY2:"T_"},anchor:o.getCaretElement(),widget:o,onHide:function(){k=false;i=null;a=null},isContext:true});k=true}function h(n,m,o){this.whenMinibuffer(function(q){var p=q.setq({completion_list:n,minibuffer_validation:function(r){if(r==null){r=q.cmd("minibuffer_contents")}if(o){return o.call(this,q,r)}return true}.$(this),minibuffer_continuation:function(r){q.setq(p);if(m){m.call(this,r)}}.$(this)})})}Ymacs_Buffer.newCommands({minibuffer_prompt:function(m,n){this.whenMinibuffer(function(p){var o=this.getMinibufferFrame();p.setCode("");p.cmd("prevent_undo",function(){p.cmd("insert",m)});p.getq("minibuffer_end_marker").setPosition(p.point());o._redrawCaret(true);if(!n){o.focus()}})},minibuffer_read_number:function(m){h.call(this,null,m,function(p,o){var q=parseInt(o,10);if(isNaN(q)){p.signalError("Please enter a number")}return !isNaN(q)})},minibuffer_read_command:function(m){var n=Array.hashKeys(this.COMMANDS).grep(function(o){return this.COMMANDS[o].ymacsInteractive},this).sort();h.call(this,n,m,function(r,p){var q=this.COMMANDS[p],o=q&&q.ymacsInteractive;if(!o){r.signalError("No such command: "+p)}return o})},minibuffer_read_function:function(m){var n=Array.hashKeys(this.COMMANDS).sort();h.call(this,n,m,function(r,p){var q=this.COMMANDS[p],o=!!q;if(!o){r.signalError("No such function: "+p)}return o})},minibuffer_read_buffer:function(m){this.whenYmacs(function(n){var o=n.buffers.map("name");o.push(o.shift());h.call(this,o,m);j.call(this)})},minibuffer_read_string:function(n,m){h.call(this,n,m)},minibuffer_prompt_end:function(){return this.whenMinibuffer(function(m){return m.getq("minibuffer_end_marker").getPosition()})},minibuffer_contents:function(){return this.whenMinibuffer(function(m){return m._bufferSubstring(m.getq("minibuffer_end_marker"))})},minibuffer_replace_input:function(m){this.whenMinibuffer(function(n){n._replaceText(n.getq("minibuffer_end_marker"),n.getCodeSize(),m);this.getMinibufferFrame()._redrawCaret(true)})},minibuffer_complete:function(){this.whenMinibuffer(function(q){var m=q.getq("completion_list"),p=q.cmd("minibuffer_contents"),n=p.replace(/-/g,"_");if(m&&m.length>0){m=m.grep(function(r){return r.indexOf(p)==0||r.indexOf(n)==0})}if(!m||m.length==0){q.signalError("No completions")}else{var o=m.common_prefix();if(o!=p){q.cmd("minibuffer_replace_input",o)}else{if(m.length==1){q.signalError("Sole completion")}else{l(this.getMinibufferFrame(),m)}}}})},minibuffer_complete_and_exit:function(){this.whenMinibuffer(function(m){if(m.getq("minibuffer_validation").call(m)){m.cmd("minibuffer_keyboard_quit",this.getq("minibuffer_continuation"))}})},minibuffer_keyboard_quit:function(m){this.whenMinibuffer(function(o){var n=this.cmd("minibuffer_contents");o.setCode("");this.cmd("other_frame");(function(p){if(m){m.call(this,p)}this.getPrefixArg()}).delayed(1,this,n)});DlPopup.clearAllPopups()}});function f(o){var n=i,m;switch(o){case"next":if(i==null){i=-1}i=a.children().rotateIndex(++i);break;case"prev":if(i==null){i=0}i=a.children().rotateIndex(--i);break}if(n!=null){m=a.children(n);m.callHooks("onMouseLeave")}n=i;m=a.children(i);m.callHooks("onMouseEnter")}function c(){if(k){return f.call(this,"next")}}function g(){if(k){return f.call(this,"prev")}}function e(){if(k){if(i!=null){this.cmd("minibuffer_replace_input",a.children()[i].userData);DlPopup.clearAllPopups()}else{this.signalError("Select something...")}}this.cmd("minibuffer_complete_and_exit")}function j(){if(!k){this.cmd("minibuffer_complete")}c.call(this)}function b(){g.call(this)}function d(){if(k){DlPopup.clearAllPopups()}else{this.cmd("minibuffer_keyboard_quit")}}DEFINE_SINGLETON("Ymacs_Keymap_Minibuffer",Ymacs_Keymap,function(n,m){n.KEYS={"C-g":"minibuffer_keyboard_quit",TAB:j,"S-TAB":b,ARROW_DOWN:c,ARROW_UP:g,ENTER:e,ESCAPE:d};m.defaultHandler=[function(){DlPopup.clearAllPopups();return false}]})})();DEFINE_CLASS("Ymacs_Completion_Popup",DlCompletionPopup);DEFINE_CLASS("Ymacs_Stream",null,function(b,a){b.DEFAULT_ARGS={buffer:["buffer",null],line:["line",0],col:["col",0]};a.nextCol=function(){++this.col};a.prevCol=function(){--this.col};a.nextLine=function(){++this.line;this.col=0};a.prevLine=function(){--this.line;this.col=0};a.peek=function(c){if(c==null){c=0}return this.buffer.code[this.line].charAt(this.col+c)};a.get=function(){var c=this.peek();this.nextCol();return c};a.lineText=function(c){if(c==null){c=this.line}return this.buffer.code[c]};a.lineIndentation=function(c){return/^\s*/.exec(this.lineText(c))[0].length};a.lookingAt=function(d){var c=this.buffer.code[this.line];if(d instanceof RegExp){return d.exec(c.substr(this.col))}else{return c.substr(this.col,d.length)==d}};a.textBefore=function(c){if(c==null){c=this.buffer._rowColToPosition(this.line,this.col)}return this.buffer.getCode().substr(0,c)};a.textAfter=function(c){if(c==null){c=this.buffer._rowColToPosition(this.line,this.col)}return this.buffer.getCode().substr(c)};a.substring=function(d,c){return this.buffer.getCode().substring(d,c)};a.substr=function(d,c){return this.buffer.getCode().substr(d,c)};a.eol=function(){return this.col==this.buffer.code[this.line].length};a.eof=function(){var d=this.buffer.code.length,c=this.line;return c>=d||c==d-1&&this.eol()};a.length=function(){return this.buffer.code.length};a.lineLength=function(c){if(c==null){c=this.line}return this.buffer.code[c].length};a.save=function(){return{buffer:this.buffer,line:this.line,col:this.col}};a.restore=function(c){this.buffer=c.buffer;this.line=c.line;this.col=c.col};a.checkStop=function(){if(this.eof()){throw this.EOF}if(this.eol()){throw this.EOL}};a.EOL=new (function(){});a.EOF=new (function(){})});DEFINE_CLASS("Ymacs_Tokenizer",DlEventProxy,function(c,b){var a={};c.define=function(d,e){a[d.toLowerCase()]=e};c.DEFAULT_EVENTS=["onFoundToken"];c.DEFAULT_ARGS={buffer:["buffer",null],type:["type",null]};c.FIXARGS=function(d){if(typeof d.type=="string"){d.type=a[d.type.toLowerCase()]}};c.CONSTRUCT=function(){var d=null;var e=null;this.quickUpdate=function(g){var f=this.buffer._positionToRowCol(g).row;this.parsers.splice(f-1,this.parsers.length+1);if(d!=null){d=Math.min(f,d)}else{d=f}clearTimeout(e);e=function(){this._do_quickUpdate(d);d=null}.delayed(1,this)};this._stopQuickUpdate=function(){clearTimeout(e);clearTimeout(this.timerUpdate)};this.reset()};b.reset=function(){this.stream=new Ymacs_Stream({buffer:this.buffer});this.theParser=this.type(this.stream,this);this.parsers=[];this.parsers[-1]=this.theParser.copy();this.timerUpdate=null;this.quickUpdate(0)};b.showProgress=function(d){if(d!=null){d=Math.round(d/this.stream.length()*100)+"%"}this.buffer.whenYmacs("updateProgress","Syntax highlighting",d)};b._do_quickUpdate=function(j){this._stopQuickUpdate();var e=this.stream,g,d=this.parsers,k;e.line=j-1;while(!(g=d[e.line])){e.prevLine()}e.nextLine();g=g();var f=0;var i=true;var h=function(){this.buffer.preventUpdates();k=i?3:20;if(++f>10){this.showProgress(this.stream.line)}while(true){try{while(true){g.next()}}catch(l){if(l===e.EOL){d[e.line]=g.copy();e.nextLine();if(--k==0){this.buffer.resumeUpdates();this.timerUpdate=setTimeout(h,i?500:50);i=false;return}}else{if(l===e.EOF){d[e.line]=g.copy();this.buffer.resumeUpdates();if(g.on_EOF){g.on_EOF()}break}else{throw l}}}}this.showProgress()}.$(this);h()};b.quickInsertLine=function(d){this.parsers.splice(d,this.parsers.length+1)};b.quickDeleteLine=function(d){this.parsers.splice(d,this.parsers.length+1)};b.onToken=function(d,g,e,f){this.callHooks("onFoundToken",d,g,e,f)};b.getParserForLine=function(h){this._stopQuickUpdate();var f=this.stream,g,d=this.parsers,j;var i=f.line;f.line=h-1;while(!(g=d[f.line])){f.prevLine()}f.nextLine();g=g();try{this.buffer.preventUpdates();while(true){if(f.line==h){return g}try{while(true){g.next()}}catch(e){if(e===f.EOL){d[f.line]=g.copy();f.nextLine()}else{if(e===f.EOF){break}else{throw e}}}}}finally{this.buffer.resumeUpdates();if(f.line<f.length()){this.timerUpdate=this._do_quickUpdate.delayed(50,this,f.line)}}};b.reparseAll=function(){this.parsers.splice(0,this.parsers.length);return this.finishParsing()};b.finishParsing=function(){this.getParserForLine(this.stream.length());return this.getLastParser()};b.getLastParser=function(){return this.parsers.peek()};b.getIndentation=function(e){var d=this.getParserForLine(e);if(d&&d.indentation instanceof Function){return d.indentation()}}});DEFINE_SINGLETON("Ymacs_Keymap_ParenMatch",Ymacs_Keymap,function(c,b){c.KEYS={"C-c \\":"goto_matching_paren","C-M-q":"indent_sexp","C-M-f && C-M-n":"forward_sexp","C-M-b && C-M-p":"backward_sexp","M-C-k":"kill_sexp","M-C-t":"transpose_sexps"};function a(e,d){return(e.line<d.line)?-1:e.line>d.line?1:e.col-d.col}Ymacs_Buffer.newCommands({matching_paren:function(){var f=this.tokenizer.getLastParser(),e=this._rowcol;if(f){var d=f.context.passedParens;return d.foreach(function(h){var g=h.closed;if(h.line==e.row&&h.col==e.col){$RETURN(this._rowColToPosition(g.line,g.col+1))}else{if(g.line==e.row&&g.col==e.col-1){$RETURN(this._rowColToPosition(h.line,h.col))}}},this)}},indent_sexp:Ymacs_Interactive(function(){var d=this.cmd("matching_paren");if(d!=null){this.cmd("indent_region",this.point(),d)}else{this.signalError("Balanced expression not found")}}),goto_matching_paren:Ymacs_Interactive(function(){var d=this.cmd("matching_paren");if(d!=null){this.cmd("goto_char",d);this.cmd("recenter_top_bottom");return true}}),forward_sexp:Ymacs_Interactive(function(){var g=this.tokenizer.finishParsing(),f=this._rowcol;if(g){var e=g.context.passedParens.mergeSort(a);var d=e.foreach(function(h){if(h.line>f.row||(h.line==f.row&&h.col>=f.col)){$RETURN(h)}},this);if(!d||!d.closed){this.signalError("Balanced expression not found");return}this.cmd("goto_char",this._rowColToPosition(d.closed.line,d.closed.col)+1);return true}}),backward_sexp:Ymacs_Interactive(function(){var g=this.tokenizer.finishParsing(),f=this._rowcol;if(g){var e=g.context.passedParens.grep("closed").map("closed").mergeSort(a);var d=e.r_foreach(function(h){if(h.line<f.row||(h.line==f.row&&h.col<f.col)){$RETURN(h)}},this);if(!d){this.signalError("Balanced expression not found");return}this.cmd("goto_char",this._rowColToPosition(d.opened.line,d.opened.col));return true}}),kill_sexp:Ymacs_Interactive(function(){this._killingAction(this.point(),this.cmd("save_excursion",function(){this.cmd("forward_sexp");return this.point()}))}),transpose_sexps:Ymacs_Interactive(function(){var d=[];this.cmd("forward_sexp");d.push(this.point());this.cmd("backward_sexp");d.push(this.point());this.cmd("backward_sexp");d.push(this.point());this.cmd("forward_sexp");d.push(this.point());this.cmd("goto_char",this._swapAreas(d))})})});Ymacs_Buffer.newMode("paren_match_mode",function(){var b=Ymacs_Keymap_ParenMatch();this.pushKeymap(b);var a=function(){this.deleteOverlay("match-paren")}.clearingTimeout(1000,this);var c={beforeInteractiveCommand:function(){a.doItNow()},afterInteractiveCommand:function(){var f=this.tokenizer.getLastParser(),e=this._rowcol;if(f){var d=f.context.passedParens;d.foreach(function(h){var g=h.closed;if(h.line==e.row&&h.col==e.col){this.setOverlay("match-paren",{line1:h.line,line2:g.line,col1:h.col,col2:g.col+1});a()}else{if(g.line==e.row&&g.col==e.col-1){this.setOverlay("match-paren",{line1:h.line,line2:g.line,col1:h.col,col2:g.col+1});a()}}},this)}}.clearingTimeout(250)};this.addEventListener(c);return function(){a.doItNow();this.popKeymap(b);this.removeEventListener(c)}});(function(){Ymacs_Buffer.newCommands({lisp_open_paren:Ymacs_Interactive(function(k){if(k==null){k="("}k+=a(k);this.cmd("insert",k);this.cmd("backward_char")}),lisp_close_paren:Ymacs_Interactive(function(l){var k=new RegExp("\\s*\\"+l,"ig");if(this.cmd("looking_at",k)){this._deleteText(this.point(),this.matchData.after)}this.cmd("insert",l)}),lisp_close_all_parens:Ymacs_Interactive(function(){var m=this.tokenizer.getParserForLine(this._rowcol.row);if(m){var l=this.tokenizer.stream;l.line=this._rowcol.row;l.col=0;try{while(l.col<this._rowcol.col){m.next()}}catch(k){}m=m.copy().context.parens;m.r_foreach(function(n){this.cmd("lisp_close_paren",a(n.type))},this)}})});var j="defmacro defun defclass defmethod defgeneric defpackage in-package defreadtable in-readtable when cond lambda let load-time-value quote macrolet progn prog1 prog2 progv go flet the if throw eval-when multiple-value-prog1 unwind-protect let* labels function symbol-macrolet block tagbody catch locally return-from setq multiple-value-call".qw().toHash(true);var b="loop do while".qw().toHash(true);var f="t nil".qw().toHash(true);var e={"(":")","{":"}","[":"]"};var i={")":"(","}":"{","]":"["};var h={"if":"3+",when:"1*",unless:"1*",defun:"2*",defgeneric:"2*",defmethod:"2*",defclass:"2*",defmacro:"2*",progn:"0*",prog1:"0*",prog2:"0*",let:"1*"};function a(k){return e[k]}function c(k){return i[k]}function d(k){return k.toLowerCase()!=k.toUpperCase()||/^[-0-9!#$%&*+./:<=>?@\[\]\^_\{\}~]$/i.test(k)}function g(k){return k!="#"&&d(k)}Ymacs_Tokenizer.define("lisp",function(u,B){var v=[],o=false,E=false,x=null,y=[],l=[],C=[],m=[],A={next:z,copy:D,indentation:k};function D(){var F=G.context={cont:v.slice(0),quote:x,inString:o,inComment:E,parens:y.slice(0),passedParens:l.slice(0),backList:C.slice(0),list:m.slice(0)};function G(){v=F.cont.slice(0);o=F.inString;x=F.quote;E=F.inComment;y=F.parens.slice(0);l=F.passedParens.slice(0);C=F.backList.slice(0),m=F.list.slice(0);return A}return G}function t(H,F,G){B.onToken(u.line,H,F,G)}function n(F){if(F==null){F={c1:u.col}}m.push(F)}function r(){return u.buffer.getq("indent_level")}function s(){var G=u.col,H=u.get(),F=H;while(!u.eol()){H=u.peek();if(!d(H)){break}F+=H;u.nextCol()}return H&&{line:u.line,c1:G,c2:u.col,id:F.toLowerCase()}}function q(G,I){var H,F=false,J=u.col;while(!u.eol()){H=u.peek();if(H===G&&!F){v.pop();o=null;t(J,u.col,I);t(u.col,++u.col,I+"-stopper");return true}F=!F&&H==="\\";u.nextCol()}t(J,u.col,I)}function w(){var G=u.lineText(),H=G.indexOf("|#",u.col);var F=/^\s*\|+/.exec(G.substr(u.col));if(F){t(u.col,u.col+=F[0].length,"mcomment-starter")}if(H>=0){v.pop();E=null;t(u.col,H,"mcomment");t(H,H+=2,"mcomment-stopper");u.col=H}else{t(u.col,G.length,"mcomment");u.col=G.length}}function p(F){var G=m&&m.length>0&&m[0].id;if(G){G=G.toLowerCase();if(F==null){return G}return G==F}}function z(){u.checkStop();if(v.length>0){return v.peek()()}var H=u.peek(),F;if((F=u.lookingAt(/^#\\(Space|Newline|.?)/i))){n();t(u.col,u.col+=F[0].length,"constant")}else{if(u.lookingAt(/^#\x27[^(]/)){n();u.col+=2;F=s();t(F.c1,F.c2,"function-name")}else{if(u.lookingAt("#|")){E={line:u.line,c1:u.col};t(u.col,u.col+=2,"mcomment-starter");v.push(w)}else{if((F=u.lookingAt(/^;+/))){t(u.col,u.col+=F[0].length,"comment-starter");t(u.col,u.col=u.lineLength(),"comment")}else{if(H==='"'){n();o={line:u.line,c1:u.col};t(u.col,++u.col,"string-starter");v.push(q.$C(H,"string"))}else{if((F=u.lookingAt(/^[+-]?(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*)(\x2f(#x[0-9a-f]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*))?/))){n();t(u.col,u.col+=F[0].length,"number")}else{if((F=a(H))){n();C.push(m);m=[];y.push({line:u.line,col:u.col,type:H});t(u.col,++u.col,"open-paren")}else{if((F=c(H))){var I=y.pop();if(!I||I.type!=F){t(u.col,++u.col,"error")}else{I.closed={line:u.line,col:u.col,opened:I};l.push(I);m=C.pop();t(u.col,++u.col,"close-paren")}}else{if(g(H)&&(F=s())){var G=H==":"?"lisp-keyword":F.id in j?"keyword":F.id in b?"builtin":F.id in f?"constant":null;if(!G){if(p("defun")&&m.length==1){G="function-name"}else{if(/^with-/i.test(F.id)){G="builtin"}}}n(F);t(F.c1,F.c2,G)}else{t(u.col,++u.col,null)}}}}}}}}}}function k(){if(o){return 0}var M=u.lineText();var I=0;var G=y.peek();if(G){var P=u.lineText(G.line);I=G.col+1;var J;if(g(P.charAt(I))){I=G.col+r();var N=/\s\S/g;N.lastIndex=G.col;J=N.exec(P);if(J){J=J.index+1}}if(m&&m.length){var O=p();if(O){O=O.replace(/\*$/,"");var K=h[O];if(!K&&/^with/.test(O)){K="1*"}if(!K){K="1+"}if(K){var H=parseInt(K,10);var L=/\+$/.test(K);var F=/\*$/.test(K);if(m.length-1<H||L){if(J){I=J}else{I+=r()}}}}}}return I}return A})})();DEFINE_SINGLETON("Ymacs_Keymap_LispMode",Ymacs_Keymap,function(b,a){b.KEYS={ENTER:"newline_and_indent","(":["lisp_open_paren","("],")":["lisp_close_paren",")"],"C-c ] && C-c C-]":"lisp_close_all_parens"}});Ymacs_Buffer.newMode("lisp_mode",function(){var b=this.tokenizer;this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"lisp"}));var a=this.setq({indent_level:2});var c=Ymacs_Keymap_LispMode();this.pushKeymap(c);var d=this.cmd("paren_match_mode",true);return function(){this.setTokenizer(b);this.setq(a);this.popKeymap(c);if(!d){this.cmd("paren_match_mode",false)}}});(function(){var i="abstract break case catch class const continue debugger default delete do else enum export extends final finally for function goto if implements import in instanceof interface native new package private protected public return static super switch synchronized throw throws transient try typeof var void let yield volatile while with".qw();var k="boolean byte char double float int long short void Array Date Function Math Number Object RegExp String".qw();var j="false null undefined Infinity NaN true arguments this".qw();var m="Infinity NaN Packages decodeURI decodeURIComponent encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt undefined window document alert prototype constructor".qw();var d=/[\[({,;+\-*=?&|!:][\x20\t\n\xa0]*$|return\s+$|typeof\s+$/;function l(o){return o.toLowerCase()!=o.toUpperCase()}function c(o){return o&&(l(o)||/^[_$]$/.test(o))}function h(o){return o&&(l(o)||/^[0-9_$]$/.test(o))}var f={"(":")","{":"}","[":"]"};var n={")":"(","}":"{","]":"["};function b(o){return f[o]}function e(o){return n[o]}function g(o,I,x,z,w,E){var y=[],B=[],q=[],G=null,r=null,D={next:C,copy:F,indentation:p};function t(){return w.buffer.getq("indent_level")}function F(){var J=K.context={cont:y.slice(0),inComment:G,inString:r,parens:B.slice(0),passedParens:q.slice(0)};function K(){y=J.cont.slice(0);G=J.inComment;r=J.inString;B=J.parens.slice(0);q=J.passedParens.slice(0);return D}return K}function v(L,J,K){E.onToken(w.line,L,J,K)}function u(){var K=w.col,L=w.get(),J=L;while(!w.eol()){L=w.peek();if(!h(L)){break}J+=L;w.nextCol()}return L&&{line:w.line,c1:K,c2:w.col,id:J}}function A(){var K=w.lineText(),L=K.indexOf("*/",w.col);var J=/^\s*\*+/.exec(K.substr(w.col));if(J){v(w.col,w.col+=J[0].length,"mcomment-starter")}if(L>=0){y.pop();G=null;v(w.col,L,"mcomment");v(L,L+=2,"mcomment-stopper");w.col=L}else{v(w.col,K.length,"mcomment");w.col=K.length}}function s(K,M){var L,J=false,N=w.col;while(!w.eol()){L=w.peek();if(L===K&&!J){y.pop();r=null;v(N,w.col,M);v(w.col,++w.col,M+"-stopper");return true}J=!J&&L==="\\";w.nextCol()}v(N,w.col,M)}function H(){var M,K=false,L=0,N=w.col;while(!w.eol()){M=w.peek();if(b(M)&&!K&&!L){L++}if(e(M)&&!K){L--;if(L<0){L=0}}if(M==="/"&&!K&&!L){y.pop();r=null;v(N,w.col,"regexp");v(w.col,++w.col,"regexp-stopper");var J=w.lookingAt(/^[gmsiy]+/);if(J){v(w.col,w.col+=J[0].length,"regexp-modifier")}return true}K=!K&&M==="\\";w.nextCol()}v(N,w.col,"regexp")}function C(){w.checkStop();if(y.length>0){return y.peek()()}var M=w.peek(),J,K;if(w.lookingAt("/*")){G={line:w.line,c1:w.col};v(w.col,w.col+=2,"mcomment-starter");y.push(A)}else{if(w.lookingAt("//")){v(w.col,w.col+=2,"comment-starter");v(w.col,w.col=w.lineLength(),"comment")}else{if(M==='"'||M==="'"){r={line:w.line,c1:w.col};v(w.col,++w.col,"string-starter");y.push(s.$C(M,"string"))}else{if((J=w.lookingAt(/^0x[0-9a-f]+|^[0-9]*\.?[0-9]+/))){v(w.col,w.col+=J[0].length,"number")}else{if(c(M)&&(K=u())){var L=K.id in o?"keyword":K.id in I?"type":K.id in x?"constant":K.id in z?"builtin":null;v(K.c1,K.c2,L)}else{if((K=b(M))){B.push({line:w.line,col:w.col,type:M});v(w.col,++w.col,"open-paren")}else{if((K=e(M))){var N=B.pop();if(!N||N.type!=K){v(w.col,++w.col,"error")}else{N.closed={line:w.line,col:w.col,opened:N};q.push(N);v(w.col,++w.col,"close-paren")}}else{if(M==="/"&&d.test(w.textBefore())){v(w.col,++w.col,"regexp-starter");y.push(H)}else{if((J=w.lookingAt(/^\s+$/))){v(w.col,w.col+=J[0].length,"trailing-whitespace")}else{v(w.col,++w.col,null)}}}}}}}}}}function p(){if(r){return 0}var T=w.line;var P=w.lineText();var K=0;if(G){var N=w.lineText(G.line);K=G.c1+1;if(!/^\s*\*/.test(P)){var R=/[^\s*]/g;R.lastIndex=G.c1+1;var L=R.exec(N);if(L){K=L.index}}return K}var J=B.peek();if(J){var R=new RegExp("^\\s*\\"+f[J.type]);var M=R.test(P);var S=w.lineText(J.line);R=/\S/g;R.lastIndex=J.col+1;var L=R.exec(S);if(L){K=M?J.col:L.index}else{K=w.lineIndentation(J.line)+t();if(M){K-=t()}}}if(T>0){var O=w.textBefore();if(/\)\s*$/.test(O)){J=q.peek();var Q=w.lineText(J.line);if(/^\s*(if|for|while)\W/.test(Q)){K+=t()}}else{if(/\Welse\s*$/.test(O)){K+=t()}}}if(/^\s*(case|default)\W/.test(P)){K-=t()/2}return K}return D}Ymacs_Tokenizer.define("js",g.$C(i.toHash(true),k.toHash(true),j.toHash(true),m.toHash(true)));var a=m.concat("DEFINE_CLASS DEFINE_SINGLETON DEFINE_HIDDEN_CLASS DEFAULT_ARGS DEFAULT_EVENTS FIXARGS CONSTRUCT BEFORE_BASE FINISH_OBJECT_DEF D P $".qw());Ymacs_Tokenizer.define("js-dynarchlib",g.$C(i.toHash(true),k.toHash(true),j.toHash(true),a.toHash(true)))})();DEFINE_SINGLETON("Ymacs_Keymap_CLanguages",Ymacs_Keymap,function(b,a){b.KEYS={ENTER:"newline_and_indent","} && ) && ] && : && ; && { && ( && [ && *":"c_insert_and_indent"}});Ymacs_Buffer.newMode("javascript_mode",function(a){var b=this.tokenizer;var c=Ymacs_Keymap_CLanguages();this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:a?"js-dynarchlib":"js"}));this.pushKeymap(c);var d=this.cmd("paren_match_mode",true);return function(){this.setTokenizer(b);this.popKeymap(c);if(!d){this.cmd("paren_match_mode",false)}}});Ymacs_Buffer.newCommands({javascript_dl_mode:Ymacs_Interactive(function(){return this.cmd("javascript_mode",true)}),c_electric_block:Ymacs_Interactive(function(){this.cmd("indent_line");this.cmd("insert","{\n\n}");this.cmd("indent_line");this.cmd("backward_line",1);this.cmd("indent_line")}),c_insert_and_indent:Ymacs_Interactive(function(){var a;if((a=this.cmd("self_insert_command"))){this.cmd("indent_line");return a}})});Ymacs_Tokenizer.define("xml",function(g,o){var r=[],i=[],b=null,s=null,n={next:m,copy:p,indentation:a};function d(){return g.buffer.getq("indent_level")}function f(w,u,v){o.onToken(g.line,w,u,v)}function k(u){return u.toLowerCase()!=u.toUpperCase()}function t(u){return u&&(k(u)||/^[:_-]$/.test(u))}function q(u){return u&&(k(u)||/^[0-9_-]$/.test(u))}function e(){var v=g.col,w=g.get(),u=w;while(!g.eol()){w=g.peek();if(!q(w)){break}u+=w;g.nextCol()}return w&&{line:g.line,c1:v,c2:g.col,id:u}}function c(v){var w,u=false,x=g.col;while(!g.eol()){w=g.peek();if(w===v&&!u){i.pop();f(x,g.col,"string");f(g.col,++g.col,"string-stopper");return}u=!u&&w==="\\";g.nextCol()}f(x,g.col,"string")}function l(){var v=g.peek(),u;if(g.lookingAt(/^\x2f>/)){i.pop();b=null;f(g.col,++g.col,"xml-closetag-slash");f(g.col,++g.col,"xml-close-bracket")}else{if(v===">"){i.pop();r.push(b);b=null;f(g.col,++g.col,"xml-close-bracket")}else{if(t(v)&&(u=e())){f(u.c1,u.c2,"xml-attribute")}else{if(v==='"'||v==="'"){f(g.col,++g.col,"string-starter");i.push(c.$C(v))}else{f(g.col,++g.col,null)}}}}}function j(w,v){var u=g.lineText(),x=u.indexOf(v,g.col);if(x>=0){i.pop();f(g.col,x,w);s=null;f(x,x+=v.length,w+"-stopper");g.col=x}else{f(g.col,u.length,w);g.col=u.length}}function h(){var u=g.lookingAt(/^([\s\xA0]*)(>?)/);if(u&&u[0]){if(u[1]){f(g.col,g.col+=u[1].length,null)}if(u[2]){f(g.col,g.col+=u[2].length,"xml-close-bracket");i.pop()}}else{f(g.col,++g.col,"error")}}function m(){g.checkStop();if(i.length>0){return i.peek()()}var w=g.peek(),v;if(g.lookingAt("<![CDATA[")){f(g.col,g.col+=9,"xml-cdata-starter");s={line:g.line,c1:g.col};i.push(j.$C("xml-cdata","]]>"))}else{if(g.lookingAt("<!--")){f(g.col,g.col+=4,"mcomment-starter");s={line:g.line,c1:g.col};i.push(j.$C("mcomment","-->"))}else{if(g.lookingAt(/^<\x2f/)&&t(g.peek(+2))){f(g.col,++g.col,"xml-open-bracket");f(g.col,++g.col,"xml-closetag-slash");var u=e(),x=r.pop();f(u.c1,u.c2,(x&&x.id==u.id?"xml-close-tag":"error"));i.push(h)}else{if(w==="<"&&t(g.peek(+1))){f(g.col,++g.col,"xml-open-bracket");var u=e();f(u.c1,u.c2,"xml-open-tag");b=u;i.push(l)}else{if((v=g.lookingAt(/^&.*?;/))){f(g.col,++g.col,"xml-entity-starter");f(g.col,g.col+=v[0].length-2,"xml-entity");f(g.col,++g.col,"xml-entity-stopper")}else{if(w==="&"){f(g.col,++g.col,"error")}else{f(g.col,++g.col,null)}}}}}}}function p(){var u=r.slice(0),x=i.slice(0),w=b,v=s;return function(){i=x.slice(0);r=u.slice(0);b=w;s=v;return n}}function a(){var u,v;if(s){u=g.lineIndentation(s.line)+d()}else{if(b){u=b.c1+b.id.length+1}else{if((v=r.peek())){u=g.lineIndentation(v.line)+d();if(/^\s*<\x2f/.test(g.lineText())){u-=d()}}}}return u}return n});DEFINE_SINGLETON("Ymacs_Keymap_XML",Ymacs_Keymap,function(b,a){b.KEYS={"C-c /":"xml_close_tag",ENTER:"newline_and_indent"}});Ymacs_Buffer.newMode("xml_mode",function(){var b=this.tokenizer;this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"xml"}));var c=Ymacs_Keymap_XML();this.pushKeymap(c);var a=this.setq({indent_level:2});return function(){this.setTokenizer(b);this.popKeymap(c);this.setq(a)}});Ymacs_Buffer.newCommands({xml_close_tag:Ymacs_Interactive(function(){this.cmd("close_last_xml_tag");this.cmd("indent_line")})});Ymacs_Tokenizer.define("css",function(i,q){var n={next:m,copy:r,indentation:b};var l=[];var c=[];var j=[];var e=null;var s=null;function r(){var u=t.context={parens:l.slice(0),passedParens:c.slice(0),cont:j.slice(0),inString:e,inComment:s};function t(){l=u.parens.slice(0);c=u.passedParens.slice(0);j=u.cont.slice(0);e=u.inString;s=u.inComment;return n}return t}function g(){return q.buffer.getq("indent_level")}var d={"(":")","{":"}","[":"]"};var o={")":"(","}":"{","]":"["};function a(t){return d[t]}function p(t){return o[t]}function h(v,t,u){q.onToken(i.line,v,t,u)}function k(){var u=i.lineText(),v=u.indexOf("*/",i.col);var t=/^\s*\*+/.exec(u.substr(i.col));if(t){h(i.col,i.col+=t[0].length,"mcomment-starter")}if(v>=0){j.pop();s=null;h(i.col,v,"mcomment");h(v,v+=2,"mcomment-stopper");i.col=v}else{h(i.col,u.length,"mcomment");i.col=u.length}}function f(u,w){var v,t=false,x=i.col;while(!i.eol()){v=i.peek();if(v===u&&!t){j.pop();e=null;h(x,i.col,w);h(i.col,++i.col,w+"-stopper");return true}t=!t&&v==="\\";i.nextCol()}h(x,i.col,w)}function m(){i.checkStop();if(j.length>0){return j.peek()()}var u=i.peek(),t;if(i.lookingAt("/*")){s={line:i.line,c1:i.col};h(i.col,i.col+=2,"mcomment-starter");j.push(k)}else{if(u==='"'||u==="'"){e={line:i.line,c1:i.col};h(i.col,++i.col,"string-starter");j.push(f.$C(u,"string"))}else{if((t=a(u))){l.push({line:i.line,col:i.col,type:u});h(i.col,++i.col,"open-paren")}else{if((t=p(u))){var v=l.pop();if(!v||v.type!=t){h(i.col,++i.col,"error")}else{v.closed={line:i.line,col:i.col,opened:v};c.push(v);h(i.col,++i.col,"close-paren")}}else{if((t=i.lookingAt(/^([a-zA-z-]+):/))){h(i.col,i.col+=t[1].length,"keyword");h(i.col,++i.col,"operator")}else{if((t=i.lookingAt(/^([0-9.]+)(px|pt|em|ex|in|cm|mm|%)/))){h(i.col,i.col+=t[1].length,"number");h(i.col,i.col+=t[2].length,"type")}else{if((t=i.lookingAt(/^(\.[a-zA-Z0-9_:-]+)/))){h(i.col,i.col+=t[1].length,"function-name")}else{if((t=i.lookingAt(/^(#[a-zA-Z0-9_:-]+)/))){h(i.col,i.col+=t[1].length,"constant")}else{if((t=i.lookingAt(/^(@[a-zA-Z0-9_:-]+)/))){h(i.col,i.col+=t[1].length,"builtin")}else{if((t=i.lookingAt(/^(url|none|auto|bold|italic|normal|inherit|print|screen|all)/))){h(i.col,i.col+=t[1].length,"builtin")}else{h(i.col,++i.col,null)}}}}}}}}}}}function b(){if(e){return 0}var B=i.line;var y=i.lineText();var u=0;if(s){var x=i.lineText(s.line);u=s.c1+1;if(!/^\s*\*/.test(y)){var z=/[^\s*]/g;z.lastIndex=s.c1+1;var v=z.exec(x);if(v){u=v.index}}return u}var t=l.peek();if(t){var z=new RegExp("^\\s*\\"+d[t.type]);var w=z.test(y);var A=i.lineText(t.line);z=/\S/g;z.lastIndex=t.col+1;var v=z.exec(A);if(v){u=w?t.col:v.index}else{u=i.lineIndentation(t.line)+g();if(w){u-=g()}}}return u}return n});DEFINE_SINGLETON("Ymacs_Keymap_CSS",Ymacs_Keymap);Ymacs_Keymap_CSS().defineKeys({ENTER:"newline_and_indent",": && } && )":"c_insert_and_indent"});Ymacs_Buffer.newMode("css_mode",function(){var a=this.tokenizer;this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"css"}));var b=this.cmd("paren_match_mode",true);this.pushKeymap(Ymacs_Keymap_CSS());return function(){this.setTokenizer(a);if(!b){this.cmd("paren_match_mode",false)}this.popKeymap(Ymacs_Keymap_CSS())}});Ymacs_Tokenizer.define("markdown",function(e,b){var d={next:c,copy:f};function f(){var g=h.context={};function h(){return d}return h}function a(i,g,h){b.onToken(e.line,i,g,h)}function c(){e.checkStop();var g;if(e.col==0&&(g=e.lookingAt(/^(#+)/))){a(0,e.col=e.lineLength(),"markdown-heading"+g[0].length)}else{if(e.line>0&&e.col==0&&(g=e.lookingAt(/^[=-]+$/))&&/\S/.test(e.lineText(e.line-1))){g=g[0].charAt(0)=="="?1:2;g="markdown-heading"+g;b.onToken(e.line-1,0,e.lineLength(e.line-1),g);a(0,e.col=e.lineLength(),g)}else{if(e.col==0&&(g=e.lookingAt(/^[>\s]*/))){g=g[0].replace(/\s+/g,"").length;if(g>3){g=""}g="markdown-blockquote"+g;a(0,e.col=e.lineLength(),g)}else{a(e.col,++e.col,null)}}}}return d});Ymacs_Buffer.newMode("markdown_mode",function(){var a=this.tokenizer;this.setTokenizer(new Ymacs_Tokenizer({buffer:this,type:"markdown"}));return function(){this.setTokenizer(a)}});